<!DOCTYPE html>
<html lang="sk">

<head>
  <meta charset="UTF-8" />
  <title>MsO SRZ Galanta ‚Äì Rev√≠rov√Ω GPS Monitoring</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet mapa -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <!-- Marker cluster -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />
  <script
    src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"
  ></script>

  <!-- Heatmap -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <!-- UI slider -->
  <link
    rel="stylesheet"
    href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"
  />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

  <style>
    :root {
      --bg: #020712;
      --card: #0b1220;
      --accent: #4ade80;
      --accent-soft: rgba(74, 222, 128, 0.12);
      --border: rgba(255, 255, 255, 0.09);
      --text: #f9fafb;
      --muted: #9ca3af;
      --danger: #f97373;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui; }

    body {
      background: radial-gradient(circle at top, #022c22, #020617 45%, #000);
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
    }

    .shell { max-width: 1500px; margin: 0 auto; }

    header {
      margin-bottom: 14px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    header h1 {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.04em;
      display: flex; gap: 10px;
      align-items: center;
    }

    .map-wrapper {
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      height: 600px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    #map { height: 100%; width: 100%; }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }

    select, button {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.85);
      color: var(--text);
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
    }

    #slider-range { width: 300px; margin-left: 10px; }

    .legend {
      margin-top: 10px;
      padding: 10px;
      background: #0f172a;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 13px;
    }

    .legend div { margin-bottom: 5px; }

    .legend span.box {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 6px;
      border-radius: 2px;
    }
  </style>
</head>
<body>

  <!-- Loading -->
  <div id="loadingScreen"
       style="position:fixed; inset:0; background:#000a; display:flex; flex-direction:column;
              justify-content:center; align-items:center; gap:8px; z-index:9999;">
    <div style="width:36px; height:36px; border-radius:50%; border:4px solid #444;
                border-top-color:#4ade80; animation:spin 0.8s linear infinite;"></div>
    <div style="color:white;">Naƒç√≠tavam d√°ta‚Ä¶</div>
  </div>

  <div class="shell">
    <header>
      <h1>üìç Rev√≠rov√Ω GPS Monitoring ‚Äì MsO SRZ Galanta</h1>
      <small>Live √∫daje + heatmapa + ƒçasov√° anim√°cia</small>
    </header>

    <!-- OVL√ÅDACIE PRVKY -->
    <div class="controls">

      <!-- V√Ωber rev√≠ru -->
      <select id="revirFilter">
        <option value="all">V≈°etky rev√≠ry</option>
        <option value="maly_dunaj">Mal√Ω Dunaj</option>
        <option value="cierna_voda">ƒåierna voda</option>
        <option value="dudvah">Dudv√°h</option>
        <option value="stary_haj">Star√Ω h√°j</option>
        <option value="cierny_brod">≈†trkovisko ƒåierny Brod</option>
        <option value="kandia">Kandia</option>
        <option value="zugo">Zugo</option>
      </select>

      <!-- V rev√≠ri / mimo rev√≠ru -->
      <select id="areaStateFilter">
        <option value="all">V≈°etko</option>
        <option value="in">Len v rev√≠ri</option>
        <option value="out">Len mimo rev√≠ru</option>
      </select>

      <!-- Export -->
      <button id="exportCsvBtn">‚¨á Export CSV</button>
      <button id="exportGpxBtn">‚¨á Export GPX</button>
      <button id="exportKmlBtn">‚¨á Export KML</button>

      <!-- Prep√≠naƒç Heatmapy -->
      <button id="toggleHeat">üî• Heatmapa</button>

      <!-- ƒåasov√Ω slider -->
      <div style="display:flex; align-items:center; gap:6px;">
        <span style="font-size:12px; color:#9ca3af;">ƒåas:</span>
        <div id="slider-range"></div>
        <span id="slider-label"
              style="font-size:12px; margin-left:8px; color:#4ade80;"></span>
      </div>
    </div>

    <!-- Mapa -->
    <div class="map-wrapper">
      <div id="map"></div>
    </div>

    <!-- LEGENDA -->
    <div class="legend">
      <div><span class="box" style="background:#4ade80;"></span> V rev√≠ri (z√°znam)</div>
      <div><span class="box" style="background:#f87171;"></span> Mimo rev√≠ru</div>
      <div><span class="box" style="background:#fbbf24;"></span> Bez √∫dajov o rev√≠ri</div>
      <hr style="border-color:#334155; margin:8px 0;">
      <div><span class="box" style="background:#3b82f6;"></span> Mal√Ω Dunaj</div>
      <div><span class="box" style="background:#9333ea;"></span> ƒåierna voda</div>
      <div><span class="box" style="background:#f97316;"></span> Dudv√°h</div>
      <div><span class="box" style="background:#10b981;"></span> Star√Ω h√°j</div>
      <div><span class="box" style="background:#6366f1;"></span> ƒåierny Brod</div>
      <div><span class="box" style="background:#eab308;"></span> Kandia</div>
      <div><span class="box" style="background:#0ea5e9;"></span> Zugo</div>
    </div>

  </div> <!-- shell -->
<script>
// ============================================================================
// 1) PR√çPRAVA MAPY
// ============================================================================
let map = L.map("map", {
  center: [48.19, 17.73],
  zoom: 11,
  preferCanvas: true
});

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// vrstva pre markery a heatmapu
let markerCluster = L.markerClusterGroup();
let heatLayer = null;

// polygon vrstva
let polygonLayer = L.layerGroup().addTo(map);

// ============================================================================
// 2) FARBY PRE REV√çRY
// ============================================================================
const REVIROVE_FARBY = {
  "maly_dunaj": "#3b82f6",
  "cierna_voda": "#9333ea",
  "dudvah": "#f97316",
  "stary_haj": "#10b981",
  "cierny_brod": "#6366f1",
  "kandia": "#eab308",
  "zugo": "#0ea5e9"
};

// ============================================================================
// 3) POLYG√ìNY REV√çROV ‚Äî rovnak√© ako vo water_areas.dart
// ============================================================================
const REVIROVE_POLYGONY = {
  maly_dunaj: [
    [48.11057, 17.63099],
    [48.10998, 17.63455],
    [48.10887, 17.63718],
    [48.10795, 17.63922],
    [48.10705, 17.64150],
    [48.10615, 17.64380],
    [48.10544, 17.64620],
    [48.10502, 17.64872],
    [48.10481, 17.65140],
    [48.10475, 17.65428],
    [48.10501, 17.65740],
    [48.10566, 17.66021],
    [48.10659, 17.66265],
    [48.10775, 17.66480],
    [48.10902, 17.66655],
    [48.11044, 17.66792],
    [48.11201, 17.66901],
    [48.11380, 17.66977],
    [48.11563, 17.66995],
    [48.11743, 17.66948],
    [48.11922, 17.66852],
    [48.12097, 17.66727],
    [48.12255, 17.66562],
    [48.12399, 17.66368],
    [48.12530, 17.66158],
    [48.12641, 17.65930],
    [48.12742, 17.65698],
    [48.12825, 17.65444],
    [48.12898, 17.65170],
    [48.12948, 17.64890],
    [48.12970, 17.64600],
    [48.12961, 17.64330],
    [48.12922, 17.64061],
    [48.12863, 17.63807],
    [48.12785, 17.63573],
    [48.12690, 17.63355]
  ],

  cierna_voda: [
    [48.09604, 17.65006],
    [48.09684, 17.64802],
    [48.09748, 17.64523],
    [48.09592, 17.64207],
    [48.09552, 17.64202],
    [48.09404, 17.64182],
    [48.09266, 17.64230]
  ],

  dudvah: [
    [48.21410, 17.69055],
    [48.21315, 17.69320],
    [48.21222, 17.69595],
    [48.21140, 17.69860],
    [48.21032, 17.70110],
    [48.20921, 17.70355],
    [48.20790, 17.70570],
    [48.20660, 17.70750],
    [48.20515, 17.70915],
    [48.20340, 17.71045],
    [48.20160, 17.71105],
    [48.19970, 17.71105],
    [48.19765, 17.71040],
    [48.19565, 17.70905],
    [48.19375, 17.70720],
    [48.19200, 17.70500]
  ],

  stary_haj: [
    [48.16642, 17.66591],
    [48.16520, 17.66640],
    [48.16432, 17.66760],
    [48.16412, 17.66918],
    [48.16466, 17.67112],
    [48.16580, 17.67194],
    [48.16730, 17.67130],
    [48.16810, 17.66950],
    [48.16780, 17.66740],
    [48.16690, 17.66610]
  ],

  cierny_brod: [
    [48.116446, 17.612429],
    [48.114326, 17.609957],
    [48.117952, 17.609813],
    [48.115531, 17.607398],
    [48.119040, 17.607756],
    [48.116408, 17.604681],
    [48.118495, 17.604253]
  ],

  kandia: [
    [48.110882, 17.771135],
    [48.111261, 17.771207],
    [48.111310, 17.771239],
    [48.111791, 17.771897],
    [48.112020, 17.772375],
    [48.112201, 17.772813],
    [48.112391, 17.773242],
    [48.112228, 17.773557],
    [48.111810, 17.774058],
    [48.111644, 17.774135],
    [48.110909, 17.773503],
    [48.110421, 17.772366],
    [48.110599, 17.771288]
  ],

  zugo: [
    [48.152353, 17.623474],
    [48.152611, 17.623314],
    [48.152880, 17.623408],
    [48.153170, 17.623672],
    [48.153384, 17.623975],
    [48.153101, 17.624121],
    [48.152920, 17.624246],
    [48.152546, 17.624563],
    [48.152391, 17.624055],
    [48.152286, 17.623436]
  ]
};

// ============================================================================
// 4) Vykreslenie polygonov + kliknutie na polygon (filter)
// ============================================================================
function drawPolygons() {
  polygonLayer.clearLayers();

  for (const id in REVIROVE_POLYGONY) {
    const coords = REVIROVE_POLYGONY[id];
    const color = REVIROVE_FARBY[id];

    const poly = L.polygon(coords, {
      color: color,
      weight: 2,
      fillColor: color,
      fillOpacity: 0.25
    }).addTo(polygonLayer);

    // klik na polygon ‚Üí filter podƒæa rev√≠ru
    poly.on("click", () => {
      document.getElementById("revirFilter").value = id;
      applyFilters();
      map.fitBounds(poly.getBounds());
    });
  }
}

drawPolygons();
  </script>
  
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, query, orderBy, limit, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ============================================================================
// 1) FIREBASE CONFIG
// ============================================================================
const firebaseConfig = {
  apiKey: "AIzaSyAqGJD78BuuBqmW9IvFerUhFKAF5AXfJ3o",
  authDomain: "mso-srz-galanta-da8f1.firebaseapp.com",
  databaseURL: "https://mso-srz-galanta-da8f1-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "mso-srz-galanta-da8f1",
  storageBucket: "mso-srz-galanta-da8f1.firebasestorage.app",
  messagingSenderId: "985946865372",
  appId: "1:985946865372:web:a74cda10ac4984950c7e19"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ============================================================================
// 2) UI ODKAZY
// ============================================================================
const revirFilterEl = document.getElementById("revirFilter");
const areaStateFilterEl = document.getElementById("areaStateFilter");

const exportCsvBtn = document.getElementById("exportCsvBtn");
const exportGpxBtn = document.getElementById("exportGpxBtn");
const exportKmlBtn = document.getElementById("exportKmlBtn");

const toggleHeatBtn = document.getElementById("toggleHeat");

let allEvents = [];
let filteredEvents = [];

let heatEnabled = false;

// ============================================================================
// 3) ƒåASOV√ù SLIDER (posledn√Ωch 24 hod√≠n)
// ============================================================================
let sliderMin = 0;
let sliderMax = 1440;
let sliderFrom = 0;
let sliderTo = 1440;

$("#slider-range").slider({
  range: true,
  min: 0,
  max: 1440,
  values: [0, 1440],
  slide: function (event, ui) {
    sliderFrom = ui.values[0];
    sliderTo = ui.values[1];
    updateSliderLabel();
    applyFilters();
  }
});

function updateSliderLabel() {
  const fmt = m => String(m).padStart(2, "0");
  const h1 = Math.floor(sliderFrom / 60);
  const m1 = sliderFrom % 60;
  const h2 = Math.floor(sliderTo / 60);
  const m2 = sliderTo % 60;
  document.getElementById("slider-label").textContent =
    `${fmt(h1)}:${fmt(m1)} ‚Äì ${fmt(h2)}:${fmt(m2)}`;
}
updateSliderLabel();

// ============================================================================
// 4) FARBA MARKERA PODƒΩA STAVU
// ============================================================================
function markerColor(ev) {
  if (ev.areaName && ev.areaName !== null) return "#4ade80"; // zelen√° = v rev√≠ri
  if (ev.areaId === null || ev.areaId === undefined) return "#fbbf24"; // star√° apka
  return "#f87171"; // ƒçerven√° = mimo rev√≠ru? (ale toto nenast√°va, lebo appka loguje len v rev√≠ri)
}

// ============================================================================
// 5) VYKRESLENIE MARKEROV
// ============================================================================
function redrawMarkers() {
  markerCluster.clearLayers();

  filteredEvents.forEach(ev => {
    const color = markerColor(ev);

    const icon = L.divIcon({
      className: "custom-marker",
      html: `<div style="
        width:12px;height:12px;
        background:${color};
        border-radius:50%;
        border:2px solid white;
        box-shadow:0 0 8px ${color};
      "></div>`
    });

    const m = L.marker([ev.lat, ev.lon], { icon }).bindPopup(`
      <b>ƒålen:</b> ${ev.memberId ?? "nezn√°my"}<br>
      <b>ƒåas:</b> ${ev.ts.toLocaleString()}<br>
      <b>GPS:</b> ${ev.lat.toFixed(5)}, ${ev.lon.toFixed(5)}<br>
      <b>Rev√≠r:</b> ${ev.areaName ?? "<span style='color:#f87171'>mimo rev√≠ru</span>"}
    `);

    markerCluster.addLayer(m);
  });

  map.addLayer(markerCluster);
}

// ============================================================================
// 6) HEATMAPA
// ============================================================================
function redrawHeat() {
  if (heatLayer) map.removeLayer(heatLayer);

  if (!heatEnabled) return;

  const heatPoints = filteredEvents.map(e => [e.lat, e.lon, 0.4]);
  heatLayer = L.heatLayer(heatPoints, { radius: 30, blur: 15 });
  map.addLayer(heatLayer);
}

// ============================================================================
// 7) HLAVN√â FILTRE
// ============================================================================
function applyFilters() {
  const revir = revirFilterEl.value;
  const areaState = areaStateFilterEl.value;

  const now = new Date();

  filteredEvents = allEvents.filter(ev => {
    // filter rev√≠ru
    if (revir !== "all" && ev.areaId !== revir) return false;

    // filter v/mimo
    if (areaState === "in" && !ev.areaName) return false;
    if (areaState === "out" && ev.areaName) return false;

    // filter ƒçasu (slider)
    const minutes = ev.ts.getHours() * 60 + ev.ts.getMinutes();
    if (minutes < sliderFrom || minutes > sliderTo) return false;

    return true;
  });

  redrawMarkers();
  redrawHeat();
}

// listenery na filtre
revirFilterEl.onchange = applyFilters;
areaStateFilterEl.onchange = applyFilters;

// heatmap toggle
toggleHeatBtn.onclick = () => {
  heatEnabled = !heatEnabled;
  applyFilters();
};

// ============================================================================
// 8) EXPORTY
// ============================================================================
exportCsvBtn.onclick = () => {
  let csv = "memberId;lat;lon;timestamp;areaId;areaName\n";
  filteredEvents.forEach(ev => {
    csv += `${ev.memberId};${ev.lat};${ev.lon};${ev.ts.toISOString()};${ev.areaId};${ev.areaName}\n`;
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "gps_export.csv";
  a.click();
};

// GPX
exportGpxBtn.onclick = () => {
  let gpx = `<?xml version="1.0"?>
<gpx version="1.1" creator="MsO SRZ Galanta">\n`;
  filteredEvents.forEach(ev => {
    gpx += `<wpt lat="${ev.lat}" lon="${ev.lon}">
  <time>${ev.ts.toISOString()}</time>
  <name>${ev.memberId}</name>
</wpt>\n`;
  });
  gpx += "</gpx>";

  const blob = new Blob([gpx], { type: "application/gpx+xml" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "gps_export.gpx";
  a.click();
};

// KML
exportKmlBtn.onclick = () => {
  let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2"><Document>\n`;
  filteredEvents.forEach(ev => {
    kml += `<Placemark><name>${ev.memberId}</name>
<Point><coordinates>${ev.lon},${ev.lat},0</coordinates></Point>
</Placemark>\n`;
  });
  kml += "</Document></kml>";

  const blob = new Blob([kml], { type: "application/vnd.google-earth.kml+xml" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "gps_export.kml";
  a.click();
};

// ============================================================================
// 9) FIRESTORE STREAM
// ============================================================================
const staysRef = collection(db, "stays");
const qStay = query(staysRef, orderBy("timestamp", "desc"), limit(2000));

onSnapshot(qStay, snap => {
  allEvents = [];

  snap.forEach(doc => {
    const d = doc.data();
    if (!d.lat || !d.lon || !d.timestamp) return;

    allEvents.push({
      memberId: d.memberId ?? null,
      lat: d.lat,
      lon: d.lon,
      areaId: d.areaId ?? null,
      areaName: d.areaName ?? null,
      ts: d.timestamp.toDate()
    });
  });

  allEvents.sort((a, b) => b.ts - a.ts);

  document.getElementById("loadingScreen").style.display = "none";
  applyFilters();
});
</script>
<style>
  /* rot√°cia loading spinnera */
  @keyframes spin { to { transform: rotate(360deg); } }

  /* marker cluster fix */
  .marker-cluster div {
    background-color: rgba(75, 237, 128, 0.5) !important;
    border: 2px solid #4ade80 !important;
    color: white !important;
  }

  /* scroll fix ak bude legenda pr√≠li≈° dlh√° */
  .legend {
    max-width: 260px;
  }
</style>

<script>
// ============================================================================
// 10) FIX: AUTO FIT NA POLYG√ìNY PRI ZAPNUT√ç FILTRA
// ============================================================================
revirFilterEl.addEventListener("change", () => {
  const val = revirFilterEl.value;

  if (val === "all") return;

  const coords = REVIROVE_POLYGONY[val];
  if (!coords) return;

  const poly = L.polygon(coords);
  map.fitBounds(poly.getBounds(), { padding: [20, 20] });
});

// ============================================================================
// 11) AUTO-REFRESH MAPY PRI RESIZE OKNA
// ============================================================================
window.addEventListener("resize", () => {
  setTimeout(() => map.invalidateSize(), 200);
});

// ============================================================================
// 12) VYPNUTIE LOADINGU PO 10 SEK, AK BY FIRESTORE NEODPOVEDAL
// ============================================================================
setTimeout(() => {
  const el = document.getElementById("loadingScreen");
  if (el.style.display !== "none") el.innerHTML = "<b style='color:white'>ƒåak√°m na Firestore‚Ä¶</b>";
}, 10000);

// ============================================================================
// 13) KONIEC ‚Äì v≈°etko naƒç√≠tan√©
// ============================================================================
</script>

</body>
</html>

