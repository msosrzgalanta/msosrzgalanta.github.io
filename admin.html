<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <title>MsO SRZ Galanta ‚Äì GPS st√°tia pri vode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet mapa -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <style>
    :root {
      --bg: #020712;
      --card: #0b1220;
      --accent: #4ade80;
      --accent-soft: rgba(74, 222, 128, 0.12);
      --border: rgba(255, 255, 255, 0.09);
      --text: #f9fafb;
      --muted: #9ca3af;
      --danger: #f97373;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui; }

    body {
      background: radial-gradient(circle at top, #022c22, #020617 45%, #000);
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
    }

    .shell { max-width: 1400px; margin: 0 auto; }

    header {
      margin-bottom: 14px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    header h1 {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.04em;
      display: flex; gap: 10px;
      align-items: center;
    }

    header small { font-size: 12px; color: var(--muted); }
    .tagline { font-size: 13px; color: var(--muted); }

    .controls {
      margin-bottom: 12px;
      display: flex; flex-wrap: wrap;
      justify-content: space-between;
      gap: 10px;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.75);
      padding: 6px 10px;
      font-size: 12px;
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }

    .chip-dot {
      width: 8px; height: 8px; border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(74,222,128,0.8);
    }

    select, button {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.85);
      color: var(--text);
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
    }

    button:hover { background: rgba(15,23,42,1); }
    button:active { transform: translateY(1px); }
    button.danger { color: var(--danger); border-color: rgba(248,113,113,0.6); }

    main {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width:1000px) { main { grid-template-columns: 1fr; } }

    .card {
      background: radial-gradient(circle at top left, #020617, #000);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 12px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.6);
      display: flex; flex-direction: column;
    }

    #eventsList {
      margin-top: 6px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.25);
      background: #020617;
      padding: 6px;
      overflow-y: auto;
      max-height: 70vh;
    }

    .event-row {
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 4px;
      background: linear-gradient(90deg, rgba(21,128,61,0.4), rgba(17,24,39,0.95));
      border: 1px solid rgba(148,163,184,0.5);
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 6px;
      font-size: 12px;
    }

    .event-icon { font-size: 20px; }
    .event-time { font-weight: 600; color: var(--accent); }
    .event-member { color: #e5e7eb; font-weight: 500; }
    .event-meta { color: var(--muted); font-size: 11px; }

    #map {
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.5);
      min-height: 260px;
      overflow: hidden;
    }

    .loading-overlay {
      position: fixed; inset: 0; background: #000a;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center; gap: 6px;
      z-index: 999;
    }

    .spinner {
      width: 34px; height: 34px; border-radius: 50%;
      border: 3px solid rgba(148,163,184,0.4);
      border-top-color: var(--accent);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }
  </style>
</head>

<body>

  <!-- Loading -->
  <div id="loadingScreen" class="loading-overlay">
    <div class="spinner"></div>
    <div style="color:white;">Naƒç√≠tavam admin panel‚Ä¶</div>
  </div>

  <!-- Unauthorized -->
  <div id="unauth" class="hidden" style="text-align:center; margin-top:80px;">
    <h2>Neautorizovan√Ω pr√≠stup</h2>
    <p style="color:#9ca3af;">Nespr√°vne heslo.</p>
  </div>

  <!-- APP -->
  <div id="appRoot" class="shell hidden">
    <header>
      <div>
        <h1>üìç GPS st√°tia pri vode</h1>
        <small>Intern√© pou≈æitie MsO SRZ Galanta</small>
      </div>
      <div class="tagline">Live √∫daje z mobilnej aplik√°cie</div>
    </header>

    <div class="controls">
      <div class="chip"><span class="chip-dot"></span> <span id="connectionStatus">Prip√°jam‚Ä¶</span></div>
      <div class="chip">Z√°znamov: <strong id="eventsCount">0</strong></div>

      <select id="timeFilter">
        <option value="24h">Posledn√Ωch 24 hod√≠n</option>
        <option value="today">Dnes</option>
        <option value="7d">Posledn√Ωch 7 dn√≠</option>
        <option value="all">V≈°etko (max 500)</option>
      </select>

      <button id="exportCsvBtn">‚¨á Export CSV</button>
    </div>

    <main>
      <section class="card">
        <h2 style="color:#9ca3af; margin-bottom:6px;">Log st√°tia</h2>
        <div id="eventsList"></div>
      </section>

      <section class="card">
        <h2 style="color:#9ca3af; margin-bottom:6px;">Mapa</h2>
        <div id="map"></div>
      </section>
    </main>

    <footer style="margin-top:10px; color:#9ca3af; font-size:11px; text-align:center;">
      Created by Juraj B√≥≈æing ¬©
    </footer>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    /* ====== 1) HESLO ====== */
    const PASSWORD = "galanta123";
    const loadingScreen = document.getElementById("loadingScreen");
    const appRoot = document.getElementById("appRoot");
    const unauth = document.getElementById("unauth");

    async function authGate() {
      let ok = false;
      for (let i = 0; i < 3; i++) {
        const inp = prompt("Zadaj heslo:");
        if (inp === PASSWORD) { ok = true; break; }
        if (inp === null) break;
      }
      loadingScreen.classList.add("hidden");
      if (!ok) unauth.classList.remove("hidden");
      else appRoot.classList.remove("hidden");
      return ok;
    }

    if (!await authGate()) throw new Error("Unauthorized");

    /* ====== 2) FIREBASE ====== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, limit, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAqGJD78BuuBqmW9IvFerUhFKAF5AXfJ3o",
      authDomain: "mso-srz-galanta-da8f1.firebaseapp.com",
      databaseURL: "https://mso-srz-galanta-da8f1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "mso-srz-galanta-da8f1",
      storageBucket: "mso-srz-galanta-da8f1.firebasestorage.app",
      messagingSenderId: "985946865372",
      appId: "1:985946865372:web:a74cda10ac4984950c7e19"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const eventsListEl = document.getElementById("eventsList");
    const eventsCountEl = document.getElementById("eventsCount");
    const timeFilterEl = document.getElementById("timeFilter");
    const exportCsvBtn = document.getElementById("exportCsvBtn");
    const connectionStatusEl = document.getElementById("connectionStatus");

    let allEvents = [];

    /* ====== 3) MAPA ====== */
    let map = L.map("map", { center:[48.192,17.727], zoom:11 });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    let markersLayer = L.layerGroup().addTo(map);

    function formatDate(dt) {
      let d = dt;
      return (
        String(d.getDate()).padStart(2,"0")+"."+
        String(d.getMonth()+1).padStart(2,"0")+"."+
        d.getFullYear()+" "+
        String(d.getHours()).padStart(2,"0")+":"+
        String(d.getMinutes()).padStart(2,"0")
      );
    }

    function filterEvents() {
      const now = new Date();
      const mode = timeFilterEl.value;
      let from = null;

      if (mode === "24h") from = new Date(now - 24*3600*1000);
      else if (mode === "today") from = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      else if (mode === "7d") from = new Date(now - 7*24*3600*1000);

      if (!from) return allEvents;
      return allEvents.filter(e => e.ts >= from);
    }

    function renderEvents() {
      const filtered = filterEvents();
      eventsCountEl.textContent = filtered.length;
      markersLayer.clearLayers();
      eventsListEl.innerHTML = "";

      filtered.sort((a,b)=>b.ts-a.ts).forEach(ev=>{
        const row = document.createElement("div");
        row.className="event-row";

        row.innerHTML = `
          <div class="event-icon">üé£</div>
          <div class="event-time">${formatDate(ev.ts)}</div>
          <div class="event-member">ƒålen: ${ev.memberId ?? "nezn√°my"}</div>
          <div class="event-meta">GPS: ${ev.lat.toFixed(5)}, ${ev.lon.toFixed(5)}</div>
        `;

        eventsListEl.appendChild(row);

        let m = L.marker([ev.lat,ev.lon]).addTo(markersLayer);
        m.bindPopup(
          "<b>ƒålen:</b> "+(ev.memberId ?? "nezn√°my")+"<br>"+
          "<b>ƒåas:</b> "+formatDate(ev.ts)+"<br>"+
          "<b>Poloha:</b> "+ev.lat+", "+ev.lon
        );
      });

      if (filtered.length)
        map.fitBounds(filtered.map(ev=>[ev.lat,ev.lon]),{padding:[30,30]});
    }

    /* ====== CSV EXPORT ====== */
    exportCsvBtn.onclick = ()=>{
      const filtered = filterEvents();
      if (!filtered.length){ alert("≈Ωiadne d√°ta."); return; }

      let csv = "memberId;lat;lon;timestamp\n";
      filtered.sort((a,b)=>a.ts-b.ts).forEach(ev=>{
        csv += `${ev.memberId ?? ""};${ev.lat};${ev.lon};${ev.ts.toISOString()}\n`;
      });

      const blob = new Blob([csv], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "staying_log.csv";
      a.click();
      URL.revokeObjectURL(url);
    };

    timeFilterEl.onchange = renderEvents;

    /* ====== 4) FIRESTORE STREAM ‚Äî OPRAVEN√â NA "stays" ====== */
    connectionStatusEl.textContent = "Prip√°jam na Firestore‚Ä¶";

    const stayRef = collection(db, "stays"); // üëà opraven√©

    const qStay = query(stayRef, orderBy("timestamp","desc"), limit(500));

    onSnapshot(qStay, snap=>{
      connectionStatusEl.textContent = "Pripojen√© (Firestore)";
      allEvents = [];

      snap.forEach(doc=>{
        const d = doc.data();
        if (!d.lat || !d.lon || !d.timestamp) return;

        allEvents.push({
          memberId: d.memberId ?? null,
          lat: d.lat,
          lon: d.lon,
          ts: d.timestamp.toDate()
        });
      });

      renderEvents();
    });
  </script>

</body>
</html>
