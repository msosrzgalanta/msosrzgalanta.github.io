<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <title>MsO SRZ Galanta ‚Äì GPS st√°tia pri vode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet mapa -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root {
      --bg: #020712;
      --card: #0b1220;
      --accent: #4ade80;
      --accent-soft: rgba(74, 222, 128, 0.12);
      --border: rgba(255, 255, 255, 0.09);
      --text: #f9fafb;
      --muted: #9ca3af;
      --danger: #f97373;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #022c22, #020617 45%, #000);
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
    }

    .shell {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 14px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    header h1 {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header h1 span {
      font-size: 26px;
    }

    header small {
      display: block;
      font-size: 12px;
      color: var(--muted);
    }

    .tagline {
      font-size: 13px;
      color: var(--muted);
    }

    .controls {
      margin-bottom: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }

    .controls-left,
    .controls-right {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.75);
      padding: 6px 10px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .chip-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(74, 222, 128, 0.8);
    }

    select,
    button {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.85);
      color: var(--text);
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
    }

    button {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s, transform 0.05s;
    }

    button:hover {
      background: rgba(15, 23, 42, 1);
    }

    button:active {
      transform: translateY(1px);
    }

    button.danger {
      border-color: rgba(248, 113, 113, 0.6);
      color: var(--danger);
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 14px;
      align-items: stretch;
    }

    @media (max-width: 1000px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: radial-gradient(circle at top left, #020617, #020617 40%, #000);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 12px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
    }

    .card-header h2 {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--muted);
    }

    .card-header small {
      font-size: 11px;
      color: var(--muted);
    }

    #eventsList {
      margin-top: 6px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: radial-gradient(circle at top left, #020617, #020617 60%, #020617);
      padding: 6px;
      overflow-y: auto;
      max-height: 70vh;
    }

    .event-row {
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 4px;
      background: linear-gradient(
        90deg,
        rgba(15, 118, 110, 0.4),
        rgba(17, 24, 39, 0.95)
      );
      border: 1px solid rgba(148, 163, 184, 0.5);
      display: grid;
      grid-template-columns: auto 1fr;
      column-gap: 8px;
      row-gap: 2px;
      font-size: 12px;
    }

    .event-row:nth-child(odd) {
      background: linear-gradient(
        90deg,
        rgba(21, 128, 61, 0.4),
        rgba(17, 24, 39, 0.95)
      );
    }

    .event-icon {
      grid-row: 1 / span 2;
      align-self: center;
      font-size: 20px;
    }

    .event-time {
      font-weight: 600;
      color: var(--accent);
    }

    .event-member {
      color: #e5e7eb;
      font-weight: 500;
    }

    .event-meta {
      color: var(--muted);
      font-size: 11px;
    }

    #map {
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      overflow: hidden;
      flex: 1;
      min-height: 260px;
    }

    footer {
      margin-top: 12px;
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }

    .hidden {
      display: none !important;
    }

    .status-pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.8);
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .status-pill span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
    }

    .status-pill span.dot.red {
      background: var(--danger);
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #020617, #000);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      flex-direction: column;
      gap: 6px;
    }

    .spinner {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 3px solid rgba(148, 163, 184, 0.4);
      border-top-color: var(--accent);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .error-box {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(248, 113, 113, 0.7);
      background: rgba(153, 27, 27, 0.2);
      color: #fecaca;
      font-size: 12px;
      margin-bottom: 8px;
    }

    label {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    input[type="checkbox"] {
      accent-color: var(--accent);
    }
  </style>
</head>

<body>
  <!-- jednoduch√° ‚Äúbr√°na‚Äù ‚Äì zme≈à si heslo -->
  <div id="loadingScreen" class="loading-overlay">
    <div class="spinner"></div>
    <div>Naƒç√≠tavam admin panel‚Ä¶</div>
  </div>

  <div id="unauth" class="hidden" style="text-align:center; margin-top: 80px;">
    <h2>Neautorizovan√Ω pr√≠stup</h2>
    <p style="color:#9ca3af; margin-top: 8px;">
      Nespr√°vne heslo. Obr√°≈• sa na predsedu MsO SRZ Galanta.
    </p>
  </div>

  <div id="appRoot" class="shell hidden">
    <header>
      <div>
        <h1>
          <span>üìç</span> GPS st√°tia pri vode
        </h1>
        <small>MsO SRZ Galanta ‚Äì len pre intern√© pou≈æitie disciplin√°rnej komisie</small>
      </div>
      <div class="tagline">
        LIVE log ƒçlenov, ktor√≠ st√°li pri vode ‚â• 15 min ‚Äì podƒæa √∫dajov z mobilnej aplik√°cie.
      </div>
    </header>

    <div class="controls">
      <div class="controls-left">
        <div class="chip">
          <span class="chip-dot"></span>
          <span id="connectionStatus">Pripojen√© k Firebase (Firestore)</span>
        </div>
        <div class="chip">
          Udalost√≠ zobrazen√Ωch: <strong id="eventsCount">0</strong>
        </div>
      </div>
      <div class="controls-right">
        <label>
          Interval:
          <select id="timeFilter">
            <option value="24h">Posledn√Ωch 24 hod√≠n</option>
            <option value="today">Dnes</option>
            <option value="7d">Posledn√Ωch 7 dn√≠</option>
            <option value="all">V≈°etko (max 500)</option>
          </select>
        </label>
        <label>
          <input type="checkbox" id="autoScroll" checked />
          Auto scroll logu
        </label>
        <button id="exportCsvBtn" title="Export aktu√°lne filtrovan√Ωch udalost√≠ do CSV">
          ‚¨á Export CSV
        </button>
      </div>
    </div>

    <main>
      <!-- ƒΩAVO: log -->
      <section class="card">
        <div class="card-header">
          <div>
            <h2>Log st√°tia pri vode</h2>
            <small>
              Ka≈æd√Ω z√°znam reprezentuje cca 15+ min st√°tia ƒçlena na jednom mieste pri rev√≠ri.
            </small>
          </div>
          <span id="streamStatus" class="status-pill">
            <span class="dot"></span> Live stream akt√≠vny
          </span>
        </div>

        <div id="errors" class="error-box hidden"></div>
        <div id="eventsList"></div>
      </section>

      <!-- PRAVO: mapa -->
      <section class="card">
        <div class="card-header">
          <div>
            <h2>Mapa st√°tia</h2>
            <small>
              Marker = zaznamenan√© st√°tie pri vode. Klikni pre detail.
            </small>
          </div>
        </div>
        <div id="map"></div>
      </section>
    </main>

    <footer>
      V≈°etky √∫daje s√∫ len informat√≠vne. Skutoƒçn√© poru≈°enie pravidiel v≈ædy potvrdzuje ryb√°rska
      str√°≈æ. &mdash; Created by Juraj B√≥≈æing
    </footer>
  </div>

  <!-- Firebase + Firestore (v9 modular, cez CDN) -->
  <script type="module">
    // ==========================
    // 1) Jednoduch√© heslo
    // ==========================
    const PASSWORD = "galanta123"; // üîê ZME≈á SI!
    const loadingScreen = document.getElementById("loadingScreen");
    const appRoot = document.getElementById("appRoot");
    const unauth = document.getElementById("unauth");

    async function authGate() {
      let ok = false;
      for (let i = 0; i < 3; i++) {
        const input = window.prompt("Zadaj heslo pre administraƒçn√Ω panel MsO SRZ Galanta:");
        if (input === null) break; // stlaƒçil Cancel
        if (input === PASSWORD) {
          ok = true;
          break;
        }
      }
      loadingScreen.classList.add("hidden");
      if (!ok) {
        unauth.classList.remove("hidden");
        return false;
      }
      appRoot.classList.remove("hidden");
      return true;
    }

    if (!await authGate()) {
      // nespr√°vne heslo, ned√°vaj niƒç ƒèalej
      throw new Error("Unauthorized");
    }

    // ==========================
    // 2) Firebase / Firestore
    // ==========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      limit,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Tvoja konfigur√°cia ‚Äì presne t√°, ktor√∫ si mi poslal
    const firebaseConfig = {
      apiKey: "AIzaSyAqGJD78BuuBqmW9IvFerUhFKAF5AXfJ3o",
      authDomain: "mso-srz-galanta-da8f1.firebaseapp.com",
      databaseURL:
        "https://mso-srz-galanta-da8f1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "mso-srz-galanta-da8f1",
      storageBucket: "mso-srz-galanta-da8f1.firebasestorage.app",
      messagingSenderId: "985946865372",
      appId: "1:985946865372:web:a74cda10ac4984950c7e19"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const connectionStatusEl = document.getElementById("connectionStatus");
    const streamStatusEl = document.getElementById("streamStatus");
    const eventsListEl = document.getElementById("eventsList");
    const eventsCountEl = document.getElementById("eventsCount");
    const errorsEl = document.getElementById("errors");
    const timeFilterEl = document.getElementById("timeFilter");
    const autoScrollEl = document.getElementById("autoScroll");
    const exportCsvBtn = document.getElementById("exportCsvBtn");

    // ==========================
    // 3) Leaflet mapa
    // ==========================
    let map = L.map("map", {
      center: [48.192, 17.727], // orientaƒçne Galanta
      zoom: 11,
      zoomControl: true
    });

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    let markersLayer = L.layerGroup().addTo(map);

    // ==========================
    // 4) Pr√°ca s d√°tami
    // ==========================
    /**
     * V≈°etky eventy z Firestore (max 500)
     * objekt: { memberId, lat, lon, ts: Date }
     */
    let allEvents = [];

    function showError(msg) {
      errorsEl.textContent = msg;
      errorsEl.classList.remove("hidden");
    }

    function clearError() {
      errorsEl.textContent = "";
      errorsEl.classList.add("hidden");
    }

    function formatDateTime(dt) {
      if (!(dt instanceof Date)) return "-";
      const d = dt;
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2, "0");
      const mi = String(d.getMinutes()).padStart(2, "0");
      return `${dd}.${mm}.${yyyy} ${hh}:${mi}`;
    }

    function filterEvents() {
      const now = new Date();
      const value = timeFilterEl.value;
      let from = null;

      if (value === "24h") {
        from = new Date(now.getTime() - 24 * 60 * 60 * 1000);
      } else if (value === "today") {
        from = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
      } else if (value === "7d") {
        from = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      } else {
        // "all" ‚Äì bez filtra
        from = null;
      }

      if (!from) return allEvents;

      return allEvents.filter(ev => ev.ts >= from);
    }

    function renderEvents() {
      clearError();
      const filtered = filterEvents();
      eventsCountEl.textContent = filtered.length;

      eventsListEl.innerHTML = "";

      if (!filtered.length) {
        const div = document.createElement("div");
        div.style.padding = "8px 10px";
        div.style.color = "#9ca3af";
        div.style.fontSize = "12px";
        div.textContent =
          "≈Ωiadne z√°znamy pre zvolen√Ω interval. Buƒè e≈°te nikto nest√°l pri vode, alebo aplik√°cia neodoslala d√°ta.";
        eventsListEl.appendChild(div);

        markersLayer.clearLayers();
        return;
      }

      // Log ‚Äì najnov≈°ie hore
      filtered
        .sort((a, b) => b.ts.getTime() - a.ts.getTime())
        .forEach(ev => {
          const row = document.createElement("div");
          row.className = "event-row";

          const icon = document.createElement("div");
          icon.className = "event-icon";
          icon.textContent = "üé£";

          const timeEl = document.createElement("div");
          timeEl.className = "event-time";
          timeEl.textContent = formatDateTime(ev.ts);

          const memberEl = document.createElement("div");
          memberEl.className = "event-member";
          memberEl.textContent = `ƒålen: ${ev.memberId ?? "nezn√°my"}`;

          const metaEl = document.createElement("div");
          metaEl.className = "event-meta";
          metaEl.textContent = `Poloha: ${ev.lat.toFixed(5)}, ${ev.lon.toFixed(5)} (st√°tie pri vode ‚â• ~15 min)`;

          row.appendChild(icon);
          row.appendChild(timeEl);
          row.appendChild(memberEl);
          row.appendChild(metaEl);

          eventsListEl.appendChild(row);
        });

      // autoscroll
      if (autoScrollEl.checked) {
        eventsListEl.scrollTop = 0;
      }

      // Mapa ‚Äì markers z filtrovan√Ωch eventov
      markersLayer.clearLayers();

      let bounds = [];

      filtered.forEach(ev => {
        const m = L.marker([ev.lat, ev.lon]).addTo(markersLayer);
        m.bindPopup(
          `<strong>ƒålen:</strong> ${ev.memberId ?? "nezn√°my"}<br/>
           <strong>ƒåas:</strong> ${formatDateTime(ev.ts)}<br/>
           <strong>Poloha:</strong> ${ev.lat.toFixed(5)}, ${ev.lon.toFixed(5)}`
        );
        bounds.push([ev.lat, ev.lon]);
      });

      if (bounds.length >= 1) {
        map.fitBounds(bounds, { padding: [30, 30] });
      }
    }

    function exportCsv() {
      const filtered = filterEvents();
      if (!filtered.length) {
        alert("Nie je ƒço exportova≈• ‚Äì ≈æiadne d√°ta v aktu√°lnom filtri.");
        return;
      }

      const header = "memberId;lat;lon;timestamp\n";
      const rows = filtered
        .sort((a, b) => a.ts.getTime() - b.ts.getTime())
        .map(ev => {
          const tsStr = ev.ts.toISOString();
          return `${ev.memberId ?? ""};${ev.lat};${ev.lon};${tsStr}`;
        });

      const csv = header + rows.join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      const now = new Date();
      const fname = `stay_events_${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}.csv`;
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    exportCsvBtn.addEventListener("click", exportCsv);
    timeFilterEl.addEventListener("change", renderEvents);

    // ==========================
    // 5) Firestore stream
    // ==========================
    connectionStatusEl.textContent = "Pripojenie k Firestore‚Ä¶";

    try {
      const stayRef = collection(db, "stay_events");

      const qStay = query(
        stayRef,
        orderBy("timestamp", "desc"),
        limit(500) // nech to nezadus√≠≈° :)
      );

      onSnapshot(
        qStay,
        snapshot => {
          connectionStatusEl.textContent =
            "Pripojen√© k Firebase (Firestore ‚Äì stay_events)";
          streamStatusEl.innerHTML = `<span class="dot"></span> Live stream akt√≠vny`;

          allEvents = [];

          snapshot.forEach(docSnap => {
            const d = docSnap.data();
            const ts = d.timestamp && d.timestamp.toDate ? d.timestamp.toDate() : null;
            const lat = typeof d.lat === "number" ? d.lat : null;
            const lon = typeof d.lon === "number" ? d.lon : null;

            if (!ts || lat === null || lon === null) return; // skip ne√∫pln√©

            allEvents.push({
              memberId: d.memberId ?? null,
              lat,
              lon,
              ts
            });
          });

          renderEvents();
        },
        error => {
          console.error(error);
          connectionStatusEl.textContent = "Chyba pripojenia k Firestore!";
          streamStatusEl.innerHTML = `<span class="dot red"></span> Stream zastaven√Ω`;
          showError(
            "Nepodarilo sa naƒç√≠ta≈• d√°ta z Firestore. Skontroluj internet a Firebase nastavenia."
          );
        }
      );
    } catch (err) {
      console.error(err);
      connectionStatusEl.textContent = "Chyba inicializ√°cie Firebase.";
      showError("Chyba inicializ√°cie Firebase / Firestore ‚Äì skontroluj konzolu.");
    }
  </script>
</body>
</html>
