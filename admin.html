<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <title>MsO SRZ Galanta ‚Äì GPS st√°tia pri vode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet mapa -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <style>
    :root {
      --bg: #020712;
      --card: #0b1220;
      --accent: #4ade80;
      --accent-soft: rgba(74, 222, 128, 0.12);
      --border: rgba(255, 255, 255, 0.09);
      --text: #f9fafb;
      --muted: #9ca3af;
      --danger: #f97373;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui; }

    body {
      background: radial-gradient(circle at top, #022c22, #020617 45%, #000);
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
    }

    .shell { max-width: 1400px; margin: 0 auto; }

    header {
      margin-bottom: 14px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    header h1 {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.04em;
      display: flex; gap: 10px;
      align-items: center;
    }

    header small { font-size: 12px; color: var(--muted); }
    .tagline { font-size: 13px; color: var(--muted); }

    .controls {
      margin-bottom: 12px;
      display: flex; flex-wrap: wrap;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.75);
      padding: 6px 10px;
      font-size: 12px;
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }

    .chip-dot {
      width: 8px; height: 8px; border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(74,222,128,0.8);
    }

    select, button {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.85);
      color: var(--text);
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
    }

    button:hover { background: rgba(15,23,42,1); }
    button:active { transform: translateY(1px); }
    button.danger { color: var(--danger); border-color: rgba(248,113,113,0.6); }

    main {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 14px;
      position: relative;
    }
    @media (max-width:1000px) { 
      main { 
        grid-template-columns: 1fr; 
      } 
    }

    .card {
      background: radial-gradient(circle at top left, #020617, #000);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 12px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.6);
      display: flex; 
      flex-direction: column;
      position: relative;
    }

    #eventsList {
      margin-top: 6px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.25);
      background: #020617;
      padding: 6px;
      overflow-y: auto;
      max-height: 70vh;
    }

    .event-row {
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 4px;
      background: linear-gradient(90deg, rgba(21,128,61,0.4), rgba(17,24,39,0.95));
      border: 1px solid rgba(148,163,184,0.5);
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 6px;
      font-size: 12px;
    }

    .event-icon { font-size: 20px; grid-row: span 3; }
    .event-time { font-weight: 600; color: var(--accent); }
    .event-member { color: #e5e7eb; font-weight: 500; }
    .event-meta { color: var(--muted); font-size: 11px; }

    #map {
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.5);
      min-height: 260px;
      overflow: hidden;
      margin-top: 8px;
    }

    /* panel rev√≠rov v mape */
    #areasPanel {
      margin-top: 4px;
      margin-bottom: 6px;
      padding: 8px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.3);
      background: rgba(15,23,42,0.9);
      font-size: 12px;
    }

    #areasList {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin: 6px 0 8px 0;
      max-height: 120px;
      overflow-y: auto;
    }

    #areasList label {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #legend {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background:#0f172aa6;
      padding:10px 14px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.1);
      font-size:12px;
      pointer-events: none;
    }

    .loading-overlay {
      position: fixed; inset: 0; background: #000a;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center; gap: 6px;
      z-index: 999;
    }

    .spinner {
      width: 34px; height: 34px; border-radius: 50%;
      border: 3px solid rgba(148,163,184,0.4);
      border-top-color: var(--accent);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none !important; }
  </style>
</head>

<body>

  <!-- Loading -->
  <div id="loadingScreen" class="loading-overlay">
    <div class="spinner"></div>
    <div style="color:white;">Naƒç√≠tavam admin panel‚Ä¶</div>
  </div>

  <!-- Unauthorized -->
  <div id="unauth" class="hidden" style="text-align:center; margin-top:80px;">
    <h2>Neautorizovan√Ω pr√≠stup</h2>
    <p style="color:#9ca3af;">Nespr√°vne heslo.</p>
  </div>

  <!-- APP -->
  <div id="appRoot" class="shell hidden">
    <header>
      <div>
        <h1>üìç GPS st√°tia pri vode</h1>
        <small>Intern√© pou≈æitie MsO SRZ Galanta</small>
      </div>
      <div class="tagline">Live √∫daje z mobilnej aplik√°cie</div>
    </header>

    <div class="controls">
      <div class="chip"><span class="chip-dot"></span> <span id="connectionStatus">Prip√°jam‚Ä¶</span></div>
      <div class="chip">Z√°znamov: <strong id="eventsCount">0</strong></div>

      <select id="timeFilter">
        <option value="24h">Posledn√Ωch 24 hod√≠n</option>
        <option value="today">Dnes</option>
        <option value="7d">Posledn√Ωch 7 dn√≠</option>
        <option value="all">V≈°etko (max 500)</option>
      </select>

      <button id="exportCsvBtn">‚¨á Export CSV</button>
    </div>

    <main>
      <!-- ƒΩAVO: LOG -->
      <section class="card">
        <h2 style="color:#9ca3af; margin-bottom:6px;">Log st√°tia</h2>
        <div id="eventsList"></div>
      </section>

      <!-- PRAVO: MAPA + REV√çRY -->
      <section class="card">
        <h2 style="color:#9ca3af; margin-bottom:6px;">Mapa rev√≠rov a st√°t√≠</h2>

        <div id="areasPanel">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
            <span style="color:#9ca3af;">Zobrazen√© vodn√© rev√≠ry:</span>
            <button id="fitAreasBtn">üîç Zobrazi≈• v≈°etky rev√≠ry</button>
          </div>
          <div id="areasList"></div>
        </div>

        <div id="map"></div>

        <div id="legend">
          <b>Legenda</b><br/>
          <span style="color:#4ade80;">‚ñ†</span> ≈†trkovisko (polyg√≥n)<br/>
          <span style="color:#60a5fa;">‚ñ≠</span> Rieƒçny √∫sek (ƒçiara)<br/>
          <span style="color:#fbbf24;">‚óè</span> Poloha ƒçlena
        </div>
      </section>
    </main>

    <footer style="margin-top:10px; color:#9ca3af; font-size:11px; text-align:center;">
      Created by Juraj B√≥≈æing ¬©
    </footer>
  </div>

  <!-- FIREBASE + LOGIKA -->
  <script type="module">
    /* ====== 1) HESLO ====== */
    const PASSWORD = "galanta123";
    const loadingScreen = document.getElementById("loadingScreen");
    const appRoot = document.getElementById("appRoot");
    const unauth = document.getElementById("unauth");

    async function authGate() {
      let ok = false;
      for (let i = 0; i < 3; i++) {
        const inp = prompt("Zadaj heslo:");
        if (inp === PASSWORD) { ok = true; break; }
        if (inp === null) break;
      }
      loadingScreen.classList.add("hidden");
      if (!ok) unauth.classList.remove("hidden");
      else appRoot.classList.remove("hidden");
      return ok;
    }

    if (!await authGate()) throw new Error("Unauthorized");

    /* ====== 2) FIREBASE ====== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, limit, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAqGJD78BuuBqmW9IvFerUhFKAF5AXfJ3o",
      authDomain: "mso-srz-galanta-da8f1.firebaseapp.com",
      databaseURL: "https://mso-srz-galanta-da8f1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "mso-srz-galanta-da8f1",
      storageBucket: "mso-srz-galanta-da8f1.firebasestorage.app",
      messagingSenderId: "985946865372",
      appId: "1:985946865372:web:a74cda10ac4984950c7e19"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const eventsListEl = document.getElementById("eventsList");
    const eventsCountEl = document.getElementById("eventsCount");
    const timeFilterEl = document.getElementById("timeFilter");
    const exportCsvBtn = document.getElementById("exportCsvBtn");
    const connectionStatusEl = document.getElementById("connectionStatus");
    const areasListEl = document.getElementById("areasList");
    const fitAreasBtn = document.getElementById("fitAreasBtn");

    let allEvents = [];
    /* ====== 3) MAPA ====== */
    let map = L.map("map", { center:[48.192,17.727], zoom:11 });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    let markersLayer = L.layerGroup().addTo(map);
    let polygonsLayer = L.layerGroup().addTo(map);

    /* ====== 3A) VODN√â REV√çRY (podƒæa water_areas.dart) ====== */

    const waterAreas = [
      {
        id: "maly_dunaj",
        name: "Mal√Ω Dunaj ‚Äì Tom√°≈°ikovo ‚Üí Jelka",
        type: "line",
        polygon: [
          [48.11057, 17.63099],[48.10998, 17.63455],[48.10887, 17.63718],
          [48.10795, 17.63922],[48.10705, 17.64150],[48.10615, 17.64380],
          [48.10544, 17.64620],[48.10502, 17.64872],[48.10481, 17.65140],
          [48.10475, 17.65428],[48.10501, 17.65740],[48.10566, 17.66021],
          [48.10659, 17.66265],[48.10775, 17.66480],[48.10902, 17.66655],
          [48.11044, 17.66792],[48.11201, 17.66901],[48.11380, 17.66977],
          [48.11563, 17.66995],[48.11743, 17.66948],[48.11922, 17.66852],
          [48.12097, 17.66727],[48.12255, 17.66562],[48.12399, 17.66368],
          [48.12530, 17.66158],[48.12641, 17.65930],[48.12742, 17.65698],
          [48.12825, 17.65444],[48.12898, 17.65170],[48.12948, 17.64890],
          [48.12970, 17.64600],[48.12961, 17.64330],[48.12922, 17.64061],
          [48.12863, 17.63807],[48.12785, 17.63573],[48.12690, 17.63355]
        ]
      },
      {
        id: "cierna_voda",
        name: "ƒåierna voda ‚Äì Star√Ω les ‚Üí Doln√Ω Chot√°r ‚Üí Kr√°ƒæ",
        type: "line",
        polygon: [
          [48.09604, 17.65006],[48.09684, 17.64802],[48.09748, 17.64523],
          [48.09592, 17.64207],[48.09552, 17.64202],[48.09404, 17.64182],
          [48.09266, 17.64230]
        ]
      },
      {
        id: "dudvah",
        name: "Dudv√°h ‚Äì ƒåierna voda ‚Üí Mal√° Maƒça + kan√°ly",
        type: "line",
        polygon: [
          [48.21410,17.69055],[48.21315,17.69320],[48.21222,17.69595],
          [48.21140,17.69860],[48.21032,17.70110],[48.20921,17.70355],
          [48.20790,17.70570],[48.20660,17.70750],[48.20515,17.70915],
          [48.20340,17.71045],[48.20160,17.71105],[48.19970,17.71105],
          [48.19765,17.71040],[48.19565,17.70905],[48.19375,17.70720],
          [48.19200,17.70500]
        ]
      },
      {
        id: "cierny_brod",
        name: "≈†trkovisko ƒåierny Brod",
        type: "polygon",
        polygon: [
          [48.116446,17.612429],[48.114326,17.609957],[48.117952,17.609813],
          [48.115531,17.607398],[48.119040,17.607756],[48.116408,17.604681],
          [48.118495,17.604253]
        ]
      },
      {
        id: "kandia",
        name: "≈†trkovisko Kandia ‚Äì Doln√© Saliby",
        type: "polygon",
        polygon: [
          [48.110882,17.771135],[48.111261,17.771207],[48.111310,17.771239],
          [48.111791,17.771897],[48.112020,17.772375],[48.112201,17.772813],
          [48.112391,17.773242],[48.112228,17.773557],[48.111810,17.774058],
          [48.111644,17.774135],[48.110909,17.773503],[48.110421,17.772366],
          [48.110599,17.771288]
        ]
      },
      {
        id: "zugo",
        name: "≈†trkovisko Zugo",
        type: "polygon",
        polygon: [
          [48.152353,17.623474],[48.152611,17.623314],[48.152880,17.623408],
          [48.153170,17.623672],[48.153384,17.623975],[48.153101,17.624121],
          [48.152920,17.624246],[48.152546,17.624563],[48.152391,17.624055],
          [48.152286,17.623436]
        ]
      }
    ];

    /* ====== 3B) PREP√çNAƒåE REv√≠rov ====== */

    let areasVisibility = {};

    waterAreas.forEach(area => {
      areasVisibility[area.id] = true;

      const row = document.createElement("label");
      row.innerHTML = `
        <input type="checkbox" data-area="${area.id}" checked />
        ${area.name}
      `;
      areasListEl.appendChild(row);
    });

    areasListEl.addEventListener("change", e => {
      if (e.target.tagName === "INPUT") {
        const id = e.target.dataset.area;
        areasVisibility[id] = e.target.checked;
        renderWaterAreas();
      }
    });

    fitAreasBtn.onclick = () => {
      const allPolys = [];
      waterAreas.forEach(area => {
        if (!areasVisibility[area.id]) return;
        allPolys.push(...area.polygon);
      });
      if (allPolys.length > 0) {
        map.fitBounds(allPolys, { padding: [30, 30] });
      }
    };

    function renderWaterAreas() {
      polygonsLayer.clearLayers();

      waterAreas.forEach(area => {
        if (!areasVisibility[area.id]) return;

        if (area.type === "polygon") {
          L.polygon(area.polygon, {
            color: "#4ade80",
            weight: 2,
            fillColor: "#4ade80",
            fillOpacity: 0.18
          })
          .bindPopup(`<b>${area.name}</b>`)
          .addTo(polygonsLayer);

        } else if (area.type === "line") {
          L.polyline(area.polygon, {
            color: "#60a5fa",
            weight: 3
          })
          .bindPopup(`<b>${area.name}</b>`)
          .addTo(polygonsLayer);
        }
      });
    }

    renderWaterAreas();

    /* ====== 3C) POMOCN√â FUNKCIE PRE REv√≠r ====== */

    function pointInPolygon(poly, lat, lon) {
      let inside = false;
      for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
        const xi = poly[i][0], yi = poly[i][1];
        const xj = poly[j][0], yj = poly[j][1];
        const intersect = ((yi > lon) !== (yj > lon)) &&
          (lat < (xj - xi) * (lon - yi) / (yj - yi) + xi);
        if (intersect) inside = !inside;
      }
      return inside;
    }

    function distanceMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function detectAreaForPoint(lat, lon) {
      let polygonMatch = null;

      // 1) najprv polygonov√© rev√≠ry
      for (const area of waterAreas) {
        if (area.type !== "polygon") continue;
        if (pointInPolygon(area.polygon, lat, lon)) {
          polygonMatch = area;
          break;
        }
      }
      if (polygonMatch) return polygonMatch;

      // 2) potom liniov√© ‚Äì najbli≈æ≈°√≠ bod do ~80m
      let bestArea = null;
      let bestDist = Infinity;

      for (const area of waterAreas) {
        if (area.type !== "line") continue;
        for (const p of area.polygon) {
          const d = distanceMeters(lat, lon, p[0], p[1]);
          if (d < 80 && d < bestDist) {
            bestDist = d;
            bestArea = area;
          }
        }
      }
      return bestArea;
    }

    /* ====== 4) FILTER, FORM√ÅT D√ÅTUMU ====== */

    function formatDate(dt) {
      let d = dt;
      return (
        String(d.getDate()).padStart(2,"0")+"."+
        String(d.getMonth()+1).padStart(2,"0")+"."+
        d.getFullYear()+" "+
        String(d.getHours()).padStart(2,"0")+":"+
        String(d.getMinutes()).padStart(2,"0")
      );
    }

    function filterEvents() {
      const now = new Date();
      const mode = timeFilterEl.value;
      let from = null;

      if (mode === "24h") from = new Date(now - 24*3600*1000);
      else if (mode === "today") from = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      else if (mode === "7d") from = new Date(now - 7*24*3600*1000);

      if (!from) return allEvents;
      return allEvents.filter(e => e.ts >= from);
    }
    function renderEvents() {
      const filtered = filterEvents();
      eventsCountEl.textContent = filtered.length;
      markersLayer.clearLayers();
      eventsListEl.innerHTML = "";

      // zoradenie od najnov≈°ieho
      filtered.sort((a,b)=>b.ts-a.ts).forEach(ev=>{
        const area = detectAreaForPoint(ev.lat, ev.lon);
        const areaName = area ? area.name : "Mimo rev√≠ru / nezaraden√©";

        const row = document.createElement("div");
        row.className="event-row";

        row.innerHTML = `
          <div class="event-icon">üé£</div>
          <div class="event-time">${formatDate(ev.ts)}</div>
          <div class="event-member">ƒålen: ${ev.memberId ?? "nezn√°my"}</div>
          <div class="event-meta">GPS: ${ev.lat.toFixed(5)}, ${ev.lon.toFixed(5)}</div>
          <div class="event-meta">Rev√≠r: ${areaName}</div>
        `;

        eventsListEl.appendChild(row);

        let m = L.circleMarker([ev.lat,ev.lon], {
          radius: 6,
          color: "#fbbf24",
          fillColor: "#fbbf24",
          fillOpacity: 0.9
        }).addTo(markersLayer);

        m.bindPopup(
          "<b>ƒålen:</b> "+(ev.memberId ?? "nezn√°my")+"<br>"+
          "<b>ƒåas:</b> "+formatDate(ev.ts)+"<br>"+
          "<b>Poloha:</b> "+ev.lat.toFixed(5)+", "+ev.lon.toFixed(5)+"<br>"+
          "<b>Rev√≠r:</b> "+areaName
        );
      });

      if (filtered.length) {
        map.fitBounds(filtered.map(ev=>[ev.lat,ev.lon]),{padding:[30,30]});
      }
    }

    /* ====== CSV EXPORT ====== */
    exportCsvBtn.onclick = ()=>{
      const filtered = filterEvents();
      if (!filtered.length){ alert("≈Ωiadne d√°ta."); return; }

      let csv = "memberId;lat;lon;timestamp;waterAreaId;waterAreaName\n";
      filtered.sort((a,b)=>a.ts-b.ts).forEach(ev=>{
        const area = detectAreaForPoint(ev.lat, ev.lon);
        csv += `${ev.memberId ?? ""};${ev.lat};${ev.lon};${ev.ts.toISOString()};${area ? area.id : ""};${area ? area.name : ""}\n`;
      });

      const blob = new Blob([csv], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "staying_log.csv";
      a.click();
      URL.revokeObjectURL(url);
    };

    timeFilterEl.onchange = renderEvents;

    /* ====== 5) FIRESTORE STREAM (kolekcia "stays") ====== */
    connectionStatusEl.textContent = "Prip√°jam na Firestore‚Ä¶";

    const stayRef = collection(db, "stays");
    const qStay = query(stayRef, o
