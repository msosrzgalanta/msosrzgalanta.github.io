<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<title>MSO SRZ GALANTA ‚Äì Admin panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Icons (FontAwesome) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
body {
  margin:0;
  background:#0b0f11;
  color:white;
  font-family:Arial, sans-serif;
  overflow:hidden;
}

/* LOGIN SCREEN */
#loginScreen {
  position:fixed;
  inset:0;
  background:black;
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:99999;
}

/* Login box */
#loginBox {
  background:#111;
  padding:40px;
  width:320px;
  border-radius:12px;
  border:1px solid #333;
  text-align:center;
}
#loginBox input {
  width:100%;
  padding:12px;
  margin-top:10px;
  background:#222;
  border:1px solid #444;
  border-radius:8px;
  color:white;
  text-align:center;
}
#loginBox button {
  width:100%;
  padding:12px;
  margin-top:15px;
  background:#1e90ff;
  border:none;
  border-radius:8px;
  color:white;
  font-weight:bold;
  cursor:pointer;
}
#loginBox button:hover {
  background:#1870d5;
}

/* üîí Admin obsah ‚Äì skryt√Ω pred prihl√°sen√≠m */
#adminWrapper {
  display:none;
}

/* Left panel */
#leftPanel {
  position:fixed;
  top:0; left:0;
  width:340px;
  height:100vh;
  background:#111;
  border-right:1px solid #333;
  padding:20px;
  overflow-y:auto;
  z-index:9999 !important;
}

/* Map */
#map {
  position:fixed;
  top:0; left:340px;
  width:calc(100vw - 340px);
  height:100vh;
  z-index:1 !important;
}

/* Sections */
.section {
  margin-bottom:25px;
  padding-bottom:15px;
  border-bottom:1px solid #333;
}

h1 {
  font-size:22px;
  margin:0 0 15px 0;
  text-transform:uppercase;
  letter-spacing:1px;
}

/* Buttons */
button {
  width:100%;
  padding:12px;
  border:none;
  border-radius:8px;
  background:#2563eb;
  color:white;
  font-weight:bold;
  cursor:pointer;
  margin-top:6px;
}
button:hover {
  background:#1d4ed8;
}

/* Tabs */
.tabButton {
  width:32%;
  background:#374151;
  font-size:13px;
}
.tabButton.active {
  background:#1e40af;
}

/* Textarea */
textarea {
  width:100%;
  height:160px;
  background:#000;
  color:#0f0;
  border:1px solid #333;
  border-radius:8px;
  padding:10px;
  font-family:monospace;
  font-size:13px;
}

/* Firebase label */
#firebaseStatus {
  padding:8px;
  border-radius:6px;
  background:#222;
  margin-bottom:10px;
  display:block;
  text-align:center;
  font-size:13px;
}

/* Hidden mode sections */
#monitoringControls,
#editorControls,
#incidentsControls {
  display:none;
}

/* Log box */
#logBox {
  max-height:220px;
  overflow-y:auto;
  background:#000;
  padding:10px;
  border-radius:8px;
  border:1px solid #333;
  font-size:12px;
}
.logEntry {
  margin-bottom:6px;
  border-bottom:1px dashed #333;
  padding-bottom:4px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div id="loginBox">
    <h2>üîê Admin ‚Äì MSO SRZ GALANTA</h2>
    <input type="password" id="pwd" placeholder="Zadajte heslo">
    <button onclick="checkLogin()">PRIHL√ÅSI≈§</button>
  </div>
</div>

<!-- ADMIN OBSAH -->
<div id="adminWrapper">

<div id="leftPanel">
  <h1>üó∫Ô∏è Admin panel</h1>

  <span id="firebaseStatus">‚óè Firebase: nezn√°me</span>

  <div class="section" style="display:flex;gap:4px;justify-content:space-between;">
    <button id="tabMonitoring" class="tabButton active">üëÅ Monitoring</button>
    <button id="tabEditor" class="tabButton">‚úè Editor</button>
    <button id="tabIncidents" class="tabButton">üìõ Incidenty</button>
  </div>

  <!-- MONITORING -->
  <div id="monitoringControls">
    <div class="section">
      <h3>üéØ Filter podƒæa rev√≠ru</h3>
      <label for="monitorRevirSelect">Rev√≠r:</label>
      <select id="monitorRevirSelect">
        <option value="">‚Äì v≈°etky ‚Äì</option>
      </select>
      <button onclick="exportStaysCSV()">üì§ Export stays CSV</button>
    </div>

    <div class="section">
      <h3>üìù Lok√°lne logy</h3>
      <div id="logBox">Inicializujem‚Ä¶</div>
    </div>
  </div>

  <!-- EDITOR -->
  <div id="editorControls">
    <div class="section">
      <h3>‚úè V√Ωber rev√≠ru</h3>
      <select id="editorRevirSelect" onchange="loadEditorRevir(this.value)">
        <option value="">-- vyber rev√≠r --</option>
      </select>
    </div>

    <div class="section">
      <button onclick="enableAddMode()">‚ûï Prida≈• bod</button>
      <button onclick="deleteLastPoint()">üóë Zmaza≈• posledn√Ω bod</button>
      <button onclick="resetCurrentRevir()">‚ôª Reset</button>
      <button onclick="exportEditorCSV()">üì§ Export CSV</button>
    </div>

    <div class="section">
      <h3>üìå JSON s√∫radnice</h3>
      <textarea id="coordsBox" readonly></textarea>
    </div>

    <div class="section">
      <h3>üìù Firebase logy</h3>
      <div id="adminLogBox">Naƒç√≠tavam logy‚Ä¶</div>
    </div>
  </div>

  <!-- INCIDENTY -->
  <div id="incidentsControls">
    <div class="section">
      <h3>üìõ Incidenty</h3>
      <button onclick="exportIncidentsCSV()">üì§ Export CSV</button>
    </div>

    <div class="section">
      <h3>üßæ Posledn√© incidenty</h3>
      <div id="incidentsList" style="
        max-height:260px;
        overflow-y:auto;
        background:#000;
        padding:10px;
        border-radius:8px;
        border:1px solid #333;
        font-size:12px;">
        Naƒç√≠tavam‚Ä¶
      </div>
    </div>
  </div>

</div><!-- leftPanel -->

<!-- MAPA -->
<div id="map"></div>

</div><!-- adminWrapper -->

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>

// =====================================================
//  REVIROVE ‚Äì v≈°etky rev√≠ry s tvojimi s√∫radnicami
// =====================================================

const REVIROVE = {

  // ========================================================================
  // STAR√ù H√ÅJ (polygon)
  // ========================================================================
  stary_haj: {
    title: "Star√Ω h√°j (odstaven√© rameno)",
    type: "polygon",
    color: "#22c55e",
    coords: [
      [48.09560742679924,17.650469541549686],
      [48.09560742679924,17.650469541549686],
      [48.097249276347505,17.646499872207645],
      [48.097249276347505,17.646499872207645],
      [48.097457192419085,17.645502090454105],
      [48.097457192419085,17.645502090454105],
      [48.09730663258917,17.644525766372684],
      [48.09730663258917,17.644525766372684],
      [48.09696966375307,17.643699645996097],
      [48.09696966375307,17.643699645996097],
      [48.09630288912204,17.642776966094974],
      [48.09630288912204,17.642776966094974],
      [48.09559308727092,17.64215469360352],
      [48.09559308727092,17.64215469360352],
      [48.09468251903319,17.64184355735779],
      [48.09468251903319,17.64184355735779],
      [48.09345645286143,17.64212250709534],
      [48.09345645286143,17.64212250709534],
      [48.0924741448349,17.64260530471802],
      [48.0924741448349,17.64260530471802]
    ]
  },

  // ========================================================================
  // STAR√Å ƒåIERNA VODA (line)
  // ========================================================================
  stara_cierna_voda: {
    title: "Star√° ƒåierna voda",
    type: "line",
    color: "#eab308",
    coords: [
      [48.059040891386154,17.823772430419925],
      [48.06042362131095,17.822560071945194],
      [48.06091149642347,17.821594476699833],
      [48.06196615182139,17.820478677749637],
      [48.063264711439494,17.81970620155335],
      [48.064304970373605,17.819030284881595],
      [48.06446280092677,17.81868696212769],
      [48.06419735835533,17.817571163177494],
      [48.0634512421745,17.81565070152283],
      [48.06340102242772,17.81244277954102],
      [48.06403952698822,17.8109085559845],
      [48.06478563464183,17.80942797660828],
      [48.06512281436022,17.808226346969608],
      [48.06516585842062,17.807829380035404],
      [48.065058248202156,17.80721783638001],
      [48.06482150492964,17.806595563888553],
      [48.064405408054355,17.806284427642826],
      [48.06388283963185,17.806273698806766],
      [48.06334477287805,17.806617021560672],
      [48.062878443808515,17.807260751724247],
      [48.06221840159643,17.80794739723206],
      [48.061644444967385,17.808108329772953],
      [48.06103460903717,17.80794739723206],
      [48.06049651251096,17.807496786117557],
      [48.05993688615723,17.806756496429447],
      [48.05887032484794,17.804299592971805],
      [48.05873400186233,17.803355455398563],
      [48.05894207364277,17.802572250366214],
      [48.05948018641668,17.802003622055057],
      [48.06030528174587,17.802100181579593],
      [48.0613025532313,17.802497148513797],
      [48.06178324553609,17.80243277549744],
      [48.06242894455276,17.802132368087772],
      [48.06287375471931,17.801595926284794],
      [48.06305311257006,17.800812721252445],
      [48.062852231735256,17.79970765113831],
      [48.062529385894095,17.798634767532352],
      [48.062256758940244,17.79793739318848],
      [48.061826292389185,17.796789407730106],
      [48.06086377997174,17.79523372650147],
      [48.060103266048195,17.794386148452762],
      [48.05957950936031,17.793742418289188],
      [48.05900552330887,17.792819738388065],
      [48.05881897646427,17.79193997383118],
      [48.058761577299144,17.790813446044925],
      [48.05907009705913,17.78997659683228],
      [48.05967278148922,17.78974056243897],
      [48.061358825451,17.79047012329102],
      [48.06270044651161,17.790309190750126],
      [48.06333895976223,17.789847850799564],
      [48.06350396751664,17.78948307037354],
      [48.06362592942993,17.788785696029667],
      [48.06361875520771,17.78818488121033],
      [48.06402768427694,17.78597474098206],
      [48.064242908798,17.784526348114017],
      [48.06425008293319,17.783260345458988],
      [48.064070729253146,17.782777547836307],
      [48.06382680724541,17.782337665557865],
      [48.06360440676034,17.782037258148197],
      [48.063353308283595,17.782005071640018],
      [48.062699113962196,17.782605886459354],
      [48.06168752055013,17.783281803131107],
      [48.061013113898056,17.78323888778687],
      [48.06075482815959,17.782766819000248],
      [48.060919844197535,17.782005071640018],
      [48.06079070125631,17.781533002853397],
      [48.060338698410725,17.78118968009949],
      [48.06007323457219,17.779816389083866],
      [48.06047501714719,17.77873277664185],
      [48.061249874686574,17.777659893035892],
      [48.062569975484585,17.77673721313477],
      [48.063280233102326,17.77576088905335],
      [48.06409809337077,17.774269580841068],
      [48.06431331759739,17.773025035858158],
      [48.06409809337077,17.77143716812134],
      [48.064291002250215,17.769087553024296],
      [48.06492232173054,17.76874423027039],
      [48.06536711035122,17.76900172233582],
      [48.06580472121076,17.769817113876346],
      [48.06671580073566,17.77072906494141],
      [48.06780620542197,17.77098655700684],
      [48.068308357705675,17.770407199859623],
      [48.06868855546137,17.768872976303104],
      [48.06914048498909,17.76677012443543],
      [48.07114183947974,17.76346564292908],
      [48.07158657435235,17.76226401329041],
      [48.07164395921725,17.761405706405643],
      [48.07167265162569,17.759656906127933],
      [48.072024132330846,17.75848746299744],
      [48.07231395586856,17.757071256637577],
      [48.072694124032346,17.75421738624573],
      [48.07442277780741,17.749571800231937],
      [48.07514004448378,17.7484667301178],
      [48.075412603199155,17.747426033020023],
      [48.075419775777426,17.744636535644535],
      [48.075746897672154,17.74404644966126],
      [48.076256144936416,17.744067907333378],
      [48.07792012902305,17.745569944381717],
      [48.07967012318866,17.74625658988953],
      [48.08021519118044,17.746117115020756],
      [48.08186470386586,17.744314670562748],
      [48.08218025678735,17.7430272102356],
      [48.08178581533305,17.742125988006595],
      [48.08003589313634,17.73925065994263],
      [48.080007205391276,17.738456726074222],
      [48.08019367544815,17.73754477500916],
      [48.08101126694949,17.734572887420658],
      [48.08095389253121,17.733596563339237],
      [48.08045186364183,17.730860710144047],
      [48.0798637664261,17.7300238609314],
      [48.07863017481584,17.72954106330872],
      [48.076062488119945,17.728199958801273],
      [48.075653654669395,17.727674245834354],
      [48.0750224668227,17.72575378417969],
      [48.07605531563129,17.72257804870606],
      [48.075919038156385,17.721848487854007],
      [48.074161743644396,17.718136310577396],
      [48.07413305262382,17.717868089675907],
      [48.074247816610146,17.716376781463627],
      [48.07434823488819,17.715657949447635],
      [48.074986603644405,17.715089321136478],
      [48.075696689922424,17.715175151824955],
      [48.077999023483954,17.713855504989628],
      [48.07943344713083,17.713447809219364],
      [48.08074590972859,17.712492942810062],
      [48.08165672474566,17.711495161056522],
      [48.08173561347643,17.710433006286625],
      [48.081649553036875,17.709134817123417],
      [48.081850360505264,17.707364559173588],
      [48.08115470271518,17.705465555191044],
      [48.08108752929851,17.705250978469852],
      [48.08084368794045,17.704499959945682],
      [48.080886718852334,17.703233957290653],
      [48.08092257791805,17.701174020767215],
      [48.080750327504155,17.700197696685795],
      [48.08090810762477,17.699167728424076],
      [48.081467505971176,17.69854545593262],
      [48.082292248847686,17.698684930801395],
      [48.08316717900988,17.699006795883182],
      [48.08511061817679,17.700498104095463],
      [48.085662799673564,17.7005410194397],
      [48.08769047090393,17.700015306472782],
      [48.08864418738105,17.69759058952332],
      [48.0878912547899,17.693749666213993],
      [48.088213941535855,17.69283771514893],
      [48.089289549400135,17.691239118576053],
      [48.09113622502798,17.69010186195374],
      [48.09165249027322,17.689393758773807],
      [48.09337333699164,17.687162160873417],
      [48.093796369657866,17.68707633018494],
      [48.094341287963424,17.687623500823978],
      [48.09596166880581,17.68908262252808],
      [48.0979434910295,17.689125537872318],
      [48.099943725152286,17.686464786529545],
      [48.10117680561929,17.686024904251102],
      [48.10273245215147,17.685649394989017],
      [48.10495875037053,17.6860785484314],
      [48.10548204521869,17.685649394989017],
      [48.105740106469966,17.68509149551392],
      [48.10579745323874,17.68408298492432],
      [48.10549638198885,17.68237709999085],
      [48.10541036130783,17.681175470352176],
      [48.10560390763769,17.680499553680423],
      [48.105919314909954,17.68034934997559],
      [48.10634224435092,17.680402994155887],
      [48.10830487418751,17.68332123756409],
      [48.10930659050442,17.684919834136966],
      [48.1098943510627,17.685016393661503],
      [48.110281409222736,17.684919834136966],
      [48.1104821048988,17.684758901596073],
      [48.11076164399855,17.684415578842167],
      [48.111084187224165,17.684007883071903],
      [48.11157158203523,17.683632373809818],
      [48.1127398772464,17.682505846023563],
      [48.11301223672923,17.681540250778202],
      [48.11292622862743,17.6810896396637],
      [48.1128187182978,17.680671215057377],
      [48.11185111520862,17.677720785140995],
      [48.11256785998714,17.676776647567753],
      [48.11348527871572,17.676669359207157],
      [48.11408732585484,17.676669359207157],
      [48.114574692181904,17.6770555973053],
      [48.116197767941124,17.678139209747318],
      [48.11698611995551,17.67809629440308],
      [48.11811129233185,17.67779588699341],
      [48.11847678888416,17.677420377731327],
      [48.11868461909741,17.676776647567753],
      [48.11868461909741,17.676218748092655],
      [48.11816145867925,17.67533898353577],
      [48.11664928012035,17.67310738563538],
      [48.11649160965147,17.671991586685184],
      [48.116584778623384,17.67132639884949],
      [48.11714230668713,17.670950889587406],
      [48.117120806403456,17.670907974243168],
      [48.117980810732355,17.671165466308597],
      [48.11950728296229,17.671916484832767],
      [48.12085455410242,17.67232418060303],
      [48.12168435342891,17.671755552291874],
      [48.12184917406531,17.671262025833133],
      [48.121598359843446,17.67056465148926],
      [48.12118272215105,17.66885876655579],
      [48.12103939802911,17.667689323425297],
      [48.12116122355825,17.666519880294803],
      [48.12155536299673,17.665693759918216],
      [48.12176318075579,17.664964199066166],
      [48.121877838469835,17.664277553558353],
      [48.122171647694,17.663558721542362],
      [48.122508451322645,17.66306519508362],
      [48.12283092081262,17.66261458396912],
      [48.12315338827823,17.66211032867432],
      [48.12333253599552,17.661745548248295],
      [48.12328954060037,17.661176919937137]
    ]
  },

  // ========================================================================
  // ƒåIERNA VODA ‚Äì HLAVN√ù TOK (line)
  // ========================================================================
  hlavny_tok_cv: {
    title: "ƒåierna voda ‚Äì hlavn√Ω tok",
    type: "line",
    color: "#38bdf8",
    coords: [
      [48.088509281439464,17.650480319762007],
      [48.09665341318309,17.651424407958988],
      [48.10362239705547,17.650523185729984],
      [48.10732128500836,17.651724815368656],
      [48.112596757596364,17.655715942382816],
      [48.11626633217087,17.655200958251957],
      [48.11973498592419,17.656788825988773],
      [48.12199951779822,17.65914916992188],
      [48.123404050699065,17.65914916992188],
      [48.12563975854307,17.656788825988773],
      [48.127846708017316,17.655072212219242],
      [48.13117128402593,17.655930519104007],
      [48.13263288295183,17.655458450317386],
      [48.13291946609825,17.65258312225342],
      [48.134381015265824,17.651038169860843],
      [48.135527299228954,17.64987945556641],
      [48.13555595600015,17.64537334442139],
      [48.136186400919975,17.642540931701664],
      [48.13925254537435,17.641468048095707],
      [48.14059929860773,17.63988018035889],
      [48.14102910603229,17.6376485824585],
      [48.14223254767651,17.63185501098633],
      [48.143980353153594,17.629494667053226],
      [48.14547023870214,17.63018131256104],
      [48.14721793393545,17.63189792633057],
      [48.14804878456839,17.63185501098633],
      [48.149280710749125,17.630095481872562],
      [48.149968284596014,17.6286792755127],
      [48.15059855252976,17.62563228607178],
      [48.151286108720114,17.623744010925297],
      [48.153033605908355,17.62292861938477],
      [48.15437999757774,17.62468814849854],
      [48.15518208646044,17.625203132629398],
      [48.1565570668026,17.6246452331543],
      [48.15735912165245,17.624473571777347],
      [48.15873404365274,17.625503540039066],
      [48.15987978383914,17.625803947448734],
      [48.1606416252917,17.6246452331543],
      [48.16250337087082,17.61812210083008],
      [48.16536746290089,17.616319656372074],
      [48.16542113691063,17.61537551879883],
      [48.16539249681193,17.613744735717777],
      [48.16573617694091,17.612586021423343],
      [48.16642353029025,17.610783576965336],
      [48.16794140297122,17.610011100769047],
      [48.17020380905611,17.6121997833252],
      [48.171578386794366,17.611856460571293],
      [48.17255202373286,17.610740661621097],
      [48.17312474270816,17.60915279388428],
      [48.17538062273681,17.606620788574222],
      [48.17623965141095,17.607049942016605]
    ]
  },

  // ========================================================================
  // ≈†TRKOVISKO Z√öG√ì (polygon)
  // ========================================================================
  zugobrod: {
    title: "≈†trkovisko Z√∫g√≥",
    type: "polygon",
    color: "#fb7185",
    coords: [
      [48.15327166192207,17.623760104179386],
      [48.15326450020302,17.623760104179386],
      [48.15281689077894,17.623352408409122],
      [48.15262710320438,17.623271942138675],
      [48.15248386683425,17.623271942138675],
      [48.152344210988446,17.623282670974735],
      [48.15224394501857,17.623314857482914],
      [48.152383601137295,17.624339461326603],
      [48.15254474234041,17.62443602085114],
      [48.15295296445692,17.62415707111359],
      [48.15323227245493,17.623963952064518],
      [48.15326091934312,17.6239424943924],
      [48.15326091934312,17.623765468597416]
    ]
  },

  // ========================================================================
  // ≈†TRKOVISKO ƒåIERNY BROD (polygon)
  // ========================================================================
  cierny_brod: {
    title: "≈†trkovisko ƒåierny Brod",
    type: "polygon",
    color: "#a855f7",
    coords: [
      [48.115879704237145,17.612478733062748],
      [48.116247388991965,17.61291861534119],
      [48.11653406357447,17.612800598144535],
      [48.116605731970154,17.612521648406986],
      [48.116777735711956,17.61216759681702],
      [48.11754457872105,17.61096596717835],
      [48.119121229322516,17.607854604721073],
      [48.11958704864959,17.605590820312504],
      [48.1173940777248,17.603005170822147],
      [48.117121741468054,17.603101730346683],
      [48.116283223402256,17.60472178459168],
      [48.11556653044788,17.60618090629578],
      [48.11553786252177,17.606813907623295],
      [48.11524401535687,17.607371807098392],
      [48.115115008753605,17.607725858688358],
      [48.11489999702842,17.608262300491337],
      [48.11384089275412,17.610032558441166],
      [48.11379788941473,17.610762119293216],
      [48.1138767288428,17.611341476440433],
      [48.114306759957344,17.61217832565308],
      [48.11513097620056,17.613004446029667],
      [48.1155251619041,17.612800598144535],
      [48.115826174404944,17.612489461898807],
      [48.11586200910899,17.61245727539063]
    ]
  },

  // ========================================================================
  // ≈†TRKOVISKO DOLN√â SALIBY ‚Äì KANDIA (polygon)
  // ========================================================================
  kandia: {
    title: "≈†trkovisko Doln√© Saliby ‚Äì Kandia",
    type: "polygon",
    color: "#f59e0b",
    coords: [
      [48.112366615041466,17.773320078849796],
      [48.11237933465214,17.773298621177677],
      [48.1119940841629,17.77236789464951],
      [48.11157657688324,17.771517634391788],
      [48.11147085561755,17.771396934986118],
      [48.11088848881437,17.77106434106827],
      [48.11076484701296,17.771104574203495],
      [48.11065195641275,17.771225273609165],
      [48.110424382544196,17.771960198879245],
      [48.11042687177441,17.772300839424137],
      [48.110570225502926,17.772968709468845],
      [48.111595193010466,17.77432590723038],
      [48.11235315408467,17.773521244525913],
      [48.112363905225166,17.773330807685856],
      [48.11236032151192,17.77331739664078]
    ]
  },

  // ========================================================================
  // DOLN√ù DUDV√ÅH ‚Äì HLAVN√ù TOK (line)
  // ========================================================================
  dudvah: {
    title: "Doln√Ω Dudv√°h ‚Äì hlavn√Ω tok",
    type: "line",
    color: "#4ade80",
    coords: [
      [48.13294095357358,17.65487909317017],
      [48.1340238779117,17.654294371604923],
      [48.134571951936344,17.653682827949527],
      [48.136853427484574,17.65310883522034],
      [48.13809278621405,17.654020786285404],
      [48.13959000627802,17.654052972793583],
      [48.14313049180637,17.65487909317017],
      [48.14482096355737,17.657518386840824],
      [48.14599566537715,17.65887022018433],
      [48.146973200883984,17.66487836837769],
      [48.14877814373691,17.665951251983646],
      [48.149924106252776,17.667474746704105],
      [48.15069761648507,17.66732454299927],
      [48.15157138253822,17.666723728179935],
      [48.15240216269236,17.66432046890259],
      [48.15257367116233,17.66308665275574],
      [48.15307499583113,17.662281990051273],
      [48.15379116543313,17.662249803543094],
      [48.15578922577529,17.663258314132694],
      [48.15636213194986,17.66414880752564],
      [48.15849615115336,17.664674520492557],
      [48.15961325332701,17.663537263870243],
      [48.16128886097845,17.66339778900147],
      [48.161675531894836,17.663934230804447],
      [48.16224121187332,17.66381621360779],
      [48.163050338214845,17.66338706016541],
      [48.16504803797518,17.664288282394413],
      [48.1655850407711,17.66435265541077],
      [48.166086238308125,17.66484618186951],
      [48.166286715951564,17.664738893508915],
      [48.16656595136338,17.664288282394413],
      [48.166716308263126,17.66335487365723],
      [48.166687668887604,17.662432193756107],
      [48.167203175199646,17.66133785247803],
      [48.16776163452387,17.66010403633118],
      [48.16822701264883,17.659471035003666],
      [48.169551527275495,17.659524679183964],
      [48.169880860737166,17.65982508659363],
      [48.170346219631654,17.661015987396244],
      [48.17054668062331,17.66288280487061],
      [48.17068986656615,17.663987874984745],
      [48.17101919271748,17.66484618186951],
      [48.17157761048834,17.665940523147587],
      [48.1729378334574,17.6670777797699],
      [48.173274648027785,17.66708850860596],
      [48.173646910843196,17.666745185852054],
      [48.17387599430934,17.666305303573612],
      [48.17436279327667,17.665286064147953],
      [48.17525763226328,17.664545774459842],
      [48.17877240865368,17.662764787673954],
      [48.18185748221562,17.66114473342896],
      [48.1826018805138,17.660468816757206],
      [48.18316017214333,17.659814357757572],
      [48.18416221879089,17.66034007072449],
      [48.1854934790357,17.661037445068363],
      [48.18583702445374,17.660661935806278],
      [48.186645778534036,17.658516168594364],
      [48.18728275285225,17.658215761184696],
      [48.18768354162399,17.658795118331913],
      [48.18834197351627,17.659964561462406],
      [48.192537089035234,17.66335487365723],
      [48.194540796096675,17.662668228149418],
      [48.196887896144496,17.664470672607425],
      [48.19883419024312,17.66232490539551],
      [48.20118109361046,17.659492492675785],
      [48.20329893850084,17.659063339233402],
      [48.20413172322778,17.658183574676517],
      [48.20483287091002,17.656188011169437],
      [48.20524783134368,17.6551365852356],
      [48.206335297909675,17.653548717498783],
      [48.20523352241919,17.650008201599125],
      [48.206163594197434,17.64839887619019],
      [48.207637365660204,17.647755146026615],
      [48.20916832605517,17.645180225372318],
      [48.20982277836019,17.6451587677002],
      [48.21199749412656,17.64584541320801],
      [48.21371430975797,17.64417171478272],
      [48.215659964554845,17.64262676239014],
      [48.21794887554241,17.641038894653324],
      [48.2187785805047,17.63915061950684],
      [48.21903607241406,17.637519836425785],
      [48.21992297907755,17.63691902160645],
      [48.22032351253426,17.636747360229496]
    ]
  },

  // ========================================================================
  // MAL√ù DUNA–à ‚Äì HLAVN√ù TOK (line)
  // ========================================================================
  maly_dunaj: {
    title: "Mal√Ω Dunaj ‚Äì hlavn√Ω tok",
    type: "line",
    color: "#3b82f6",
    coords: [
      [48.08630728799306,17.651531696319584],
      [48.08802016630868,17.65011548995972],
      [48.088772668034665,17.649053335189823],
      [48.08971865458321,17.647562026977543],
      [48.091266595037816,17.644332647323612],
      [48.09214804030934,17.64139294624329],
      [48.09283598709652,17.638249397277836],
      [48.09341643503933,17.634032964706424],
      [48.09341643503933,17.632058858871464],
      [48.093480928850745,17.627606391906742],
      [48.093086798739925,17.62592196464539],
      [48.093301779174865,17.624012231826786],
      [48.09284315316046,17.621587514877323],
      [48.092785824621046,17.621308565139774],
      [48.09181839587885,17.61942028999329],
      [48.09157474428947,17.619227170944217],
      [48.090514129803225,17.61916279792786],
      [48.088966166698846,17.620482444763187],
      [48.08695947851198,17.623218297958378],
      [48.08590593587084,17.62388348579407],
      [48.084974213513036,17.623851299285892],
      [48.0836626065151,17.623111009597782],
      [48.08296020213133,17.62242436408997],
      [48.082372468643946,17.62067019939423],
      [48.083168057488976,17.617548108100895],
      [48.083393830460324,17.617102861404422],
      [48.08425390889206,17.61665225028992],
      [48.085368405801134,17.61616945266724],
      [48.085687340986894,17.616239190101627],
      [48.08601702471814,17.616266012191776],
      [48.08632878891122,17.61616408824921],
      [48.08647212813595,17.615734934806827],
      [48.086708636983396,17.615788578987125],
      [48.086844808250724,17.615981698036197],
      [48.087342905341416,17.615257501602176],
      [48.08777649672325,17.613267302513126],
      [48.08828533483987,17.612258791923527],
      [48.08847525200169,17.611845731735233],
      [48.090266888822974,17.610805034637455],
      [48.09236660773406,17.609989643096927],
      [48.09282882103159,17.610070109367374],
      [48.09291481374485,17.610520720481876],
      [48.093301779174865,17.61067092418671],
      [48.09516490529509,17.610472440719608],
      [48.09568083597712,17.610247135162357],
      [48.09699930197777,17.608766555786136],
      [48.09778749919965,17.606813907623295],
      [48.09775167231534,17.60565519332886],
      [48.0969778055206,17.60372400283814],
      [48.096218258265864,17.602983713150028],
      [48.09474212490469,17.60241508483887],
      [48.09234869240633,17.60168552398682],
      [48.091531746830306,17.601127624511722],
      [48.09057146087525,17.599883079528812],
      [48.09006981182794,17.597340345382694],
      [48.0900913111732,17.596095800399784],
      [48.09053562896272,17.594529390335087],
      [48.091194932156505,17.59297370910645],
      [48.09183272828934,17.591879367828373],
      [48.09245618427908,17.591503858566288],
      [48.09280732283082,17.591278553009037],
      [48.094305009320585,17.591310739517215],
      [48.09529388845095,17.59120345115662],
      [48.09635440435389,17.59068846702576],
      [48.09714977692606,17.59066700935364],
      [48.09813860134465,17.58991599082947],
      [48.099048589620956,17.588649988174442],
      [48.10023799883015,17.587544918060306],
      [48.101391556173354,17.587072849273685],
      [48.102946309896716,17.586901187896732],
      [48.10469445607566,17.58643984794617],
      [48.10531775611336,17.58598923683167],
      [48.10574044953908,17.585409879684452],
      [48.10622761731096,17.584272623062137],
      [48.10642105029262,17.58418679237366],
      [48.107839536580784,17.58066773414612],
      [48.10799714375171,17.57949829101563],
      [48.107746404843496,17.577846050262455],
      [48.10751715677116,17.577105760574344],
      [48.107244923357115,17.576633691787723],
      [48.107094477957034,17.576365470886234],
      [48.106148811072686,17.575292587280277],
      [48.105847913415126,17.57521748542786],
      [48.103763074117765,17.574520111083988],
      [48.102451946300214,17.573286294937137],
      [48.10185727074718,17.571794986724857],
      [48.101728304056856,17.570518255233768],
      [48.101928918768664,17.569541931152347],
      [48.10226566313202,17.568812370300297],
      [48.10370575775375,17.566280364990238],
      [48.10450818103419,17.566055059432987],
      [48.105797763634264,17.566301822662357],
      [48.107180446811014,17.5671923160553],
      [48.10879950003764,17.570271492004398],
      [48.10882099155164,17.570850849151615],
      [48.1096376624229,17.571859359741214],
      [48.11097009756268,17.57251381874085],
      [48.1120947605512,17.57224559783936],
      [48.11283258340829,17.571655511856083],
      [48.113556069320545,17.570346593856815],
      [48.11410046784503,17.568812370300297],
      [48.11413628333521,17.568082809448246],
      [48.11396436875464,17.567299604415897],
      [48.11377096416396,17.566580772399906],
      [48.11354174296571,17.566237449646],
      [48.113262378247775,17.566055059432987],
      [48.11291854266377,17.565883398056034],
      [48.11031104794049,17.564316987991337],
      [48.10927947504203,17.562686204910282],
      [48.10905023380809,17.562085390090946],
      [48.10796848793843,17.559177875518802],
      [48.10751715677116,17.556066513061527],
      [48.10740253235154,17.555433511734012],
      [48.10741686041797,17.55400657653809],
      [48.1072091030637,17.551345825195316],
      [48.106979852594755,17.549124956130985],
      [48.10673627285101,17.548320293426517],
      [48.10642105029262,17.548084259033207],
      [48.106263438288394,17.547901868820194],
      [48.105804927891676,17.546603679656986],
      [48.105360742044255,17.544178962707523],
      [48.10543238518251,17.541421651840214],
      [48.10618463210505,17.5387716293335],
      [48.1069726885011,17.53730177879334],
      [48.10781804465637,17.536894083023075],
      [48.10880666387664,17.536947727203373],
      [48.10966631730553,17.537323236465458],
      [48.11154317732038,17.5392758846283],
      [48.11192283914032,17.540209293365482],
      [48.11201596330929,17.541196346282963],
      [48.1120947605512,17.54124999046326],
      [48.11298301201102,17.543835639953617],
      [48.11305464452421,17.544372081756595],
      [48.113068971014876,17.544640302658085],
      [48.11442280635798,17.54653930664063],
      [48.116478562188846,17.54725813865662],
      [48.11750999057282,17.546904087066654],
      [48.11828354827235,17.546571493148807],
      [48.12191481623966,17.543599605560306],
      [48.12605429185834,17.53980159759522],
      [48.12639803953746,17.53829956054688],
      [48.126369393985414,17.53572463989258],
      [48.12593970878738,17.53448009490967],
      [48.12565324999164,17.532677650451664],
      [48.12439281231023,17.531218528747562],
      [48.122072380242265,17.530660629272464],
      [48.121871844155066,17.530403137207035],
      [48.118548560731504,17.53156185150147],
      [48.1176532428774,17.53173351287842],
      [48.11607744555866,17.53128290176392],
      [48.11493854377271,17.53000617027283],
      [48.11380677988381,17.527731657028202],
      [48.11347727431945,17.52599358558655],
      [48.11354174296571,17.52474904060364],
      [48.11413628333521,17.5217878818512],
      [48.11519641053887,17.52031803131104],
      [48.11566200003326,17.519427537918094],
      [48.116872512973934,17.516670227050785],
      [48.117574454159325,17.515178918838505],
      [48.118319360846705,17.514202594757084],
      [48.12013144451961,17.513172626495365],
      [48.120511042883464,17.512990236282352],
      [48.12243047845079,17.513612508773807],
      [48.12356921416262,17.514148950576786],
      [48.12432119560424,17.514138221740726],
      [48.12492993442232,17.514427900314335],
      [48.12737914005112,17.5148355960846],
      [48.1288973024466,17.51355886459351],
      [48.12991415970903,17.51105904579163],
      [48.12982106798,17.509149312973026],
      [48.12912645513637,17.507411241531376],
      [48.12771571766151,17.505759000778202],
      [48.124414297302536,17.506252527236942],
      [48.12311085816952,17.506413459777836],
      [48.12152090411874,17.507421970367435],
      [48.11884222158954,17.509728670120243],
      [48.11612042249026,17.50980377197266],
      [48.11410763094504,17.508913278579715],
      [48.11230966150594,17.5067675113678],
      [48.11146437923264,17.505147457122806],
      [48.11064057380809,17.501971721649173],
      [48.11064773739043,17.499514818191532],
      [48.1110632234582,17.497755289077762],
      [48.11275378729774,17.49603867530823],
      [48.114594719404735,17.49584555625916],
      [48.11616339938589,17.496757507324222],
      [48.1193364275367,17.498677968978885],
      [48.120374960773674,17.498935461044315],
      [48.12180022393421,17.49831318855286],
      [48.12322544755123,17.49607086181641],
      [48.12397027230146,17.4933135509491],
      [48.12398459574851,17.491908073425297],
      [48.12371244957169,17.4888288974762],
      [48.12314666737877,17.48658657073975],
      [48.12351191988715,17.48455882072449],
      [48.12413499170132,17.481704950332645],
      [48.12557447354273,17.479215860366825],
      [48.12740062379426,17.47811079025269],
      [48.12863950444844,17.47830390930176]
    ]
  }

};
</script>

<script>
// =====================================================
//  GLOBAL PREMENN√â ‚Äì DOM
// =====================================================
const loginScreenEl      = document.getElementById("loginScreen");
const pwdInputEl         = document.getElementById("pwd");
const firebaseStatusEl   = document.getElementById("firebaseStatus");

const tabMonitoringBtn   = document.getElementById("tabMonitoring");
const tabEditorBtn       = document.getElementById("tabEditor");
const tabIncidentsBtn    = document.getElementById("tabIncidents");

const monitoringControls = document.getElementById("monitoringControls");
const editorControls     = document.getElementById("editorControls");
const incidentsControls  = document.getElementById("incidentsControls");

const monitorRevirSelect = document.getElementById("monitorRevirSelect");
const editorRevirSelect  = document.getElementById("editorRevirSelect");

const logBoxEl           = document.getElementById("logBox");
const adminLogBoxEl      = document.getElementById("adminLogBox");
const coordsBoxEl        = document.getElementById("coordsBox");
const incidentsListEl    = document.getElementById("incidentsList");

// =====================================================
//  LOGIN
// =====================================================
function checkLogin() {
  const pwd = pwdInputEl.value;
  if (pwd === "galanta123") {
    loginScreenEl.style.display = "none";
    document.getElementById("adminWrapper").style.display = "block";   // üî• DOPLNEN√â
    setTimeout(() => map.invalidateSize(), 300); // üî• aby sa mapa prekreslila
  } else {
    alert("‚ùå Nespr√°vne heslo!");
  }
}

// =====================================================
//  LOK√ÅLNE LOGY
// =====================================================
function addLocalLog(msg) {
  if (!logBoxEl) return;
  const t = new Date().toLocaleTimeString("sk-SK");
  const row = document.createElement("div");
  row.className = "logEntry";
  row.textContent = `[${t}] ${msg}`;
  logBoxEl.appendChild(row);
  logBoxEl.scrollTop = logBoxEl.scrollHeight;
}

addLocalLog("Admin panel naƒç√≠tan√Ω.");

// =====================================================
//  FIREBASE INIT
// =====================================================
let db = null;

function setFirebaseStatus(ok, msg) {
  if (!firebaseStatusEl) return;
  firebaseStatusEl.textContent = (ok ? "‚óè Firebase: " : "‚óè Firebase ERROR: ") + msg;
  firebaseStatusEl.style.background = ok ? "#064e3b" : "#7f1d1d";
  firebaseStatusEl.style.color      = "#f9fafb";
}

try {
  const firebaseConfig = {
    apiKey: "AIzaSyAqGJD78BuuBqmW9IvFerUhFKAF5AXfJ3o",
    authDomain: "mso-srz-galanta-da8f1.firebaseapp.com",
    databaseURL: "https://mso-srz-galanta-da8f1-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "mso-srz-galanta-da8f1",
    storageBucket: "mso-srz-galanta-da8f1.appspot.com",
    messagingSenderId: "985946865372",
    appId: "1:985946865372:web:a74cda10ac4984950c7e19"
  };
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  setFirebaseStatus(true, "OK");
  addLocalLog("Firebase inicializovan√Ω.");
} catch (e) {
  console.error("Firebase init error", e);
  setFirebaseStatus(false, "Chyba inicializ√°cie");
  addLocalLog("Firebase chyba inicializ√°cie: " + e.message);
}

// =====================================================
//  MAPA ‚Äì INIT
// =====================================================
let map = L.map("map", {
  zoomControl: true,
  zoomSnap: 0,
  zoomDelta: 0.25,
  wheelPxPerZoomLevel: 80
}).setView([48.18, 17.72], 11);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "&copy; OpenStreetMap"
}).addTo(map);

// vrstva pre statick√© rev√≠ry
let revirLayerStatic = L.layerGroup().addTo(map);
// vrstva pre stays (monitoring)
let staysLayer       = L.layerGroup().addTo(map);
// vrstva pre editor (akt√≠vny rev√≠r + edit markery)
let editorLayer      = L.layerGroup().addTo(map);
// vrstva pre incidenty
let incidentsLayer   = L.layerGroup().addTo(map);

// =====================================================
//  MONITORING ‚Äì STAYS Z FIRESTORE
// =====================================================
let allStays          = [];
let currentMonitorKey = "";

// vyƒçistenie markerov stays
function clearStayMarkers() {
  staysLayer.clearLayers();
}

// prekreslenie stays podƒæa filtra
function redrawStays() {
  clearStayMarkers();
  if (!allStays.length) return;

  const key = currentMonitorKey;
  const filtered = allStays.filter(ev => !key || ev.areaId === key);

  if (!filtered.length) {
    addLocalLog("Pre zvolen√Ω filter nie s√∫ ≈æiadne stays.");
    return;
  }

  const bounds = [];

  filtered.forEach(ev => {
    let color = "#facc15";
    if (REVIROVE && ev.areaId && REVIROVE[ev.areaId]) {
      color = REVIROVE[ev.areaId].color || color;
    }

    const m = L.circleMarker([ev.lat, ev.lon], {
      radius: 5,
      color,
      fillColor: color,
      fillOpacity: 0.9,
      weight: 2
    }).addTo(staysLayer);

    const tsText = ev.ts ? ev.ts.toLocaleString("sk-SK") : "nezn√°my ƒças";

    m.bindPopup(
      "<b>ƒålen (memberId):</b> " + (ev.memberId || "-") + "<br>" +
      "<b>Rev√≠r:</b> " + (ev.areaName || ev.areaId || "-") + "<br>" +
      "<b>ƒåas:</b> " + tsText + "<br>" +
      "<b>GPS:</b> " + ev.lat.toFixed(5) + ", " + ev.lon.toFixed(5)
    );

    bounds.push([ev.lat, ev.lon]);
  });

  if (bounds.length) {
    try {
      map.fitBounds(L.latLngBounds(bounds).pad(0.25));
    } catch (e) {}
  }
}

// listener na kolekciu "stays"
if (db) {
  db.collection("stays")
    .orderBy("timestamp", "desc")
    .limit(2000)
    .onSnapshot(function (snap) {
      allStays = [];
      snap.forEach(function (doc) {
        const d = doc.data();
        if (!d || typeof d.lat !== "number" || typeof d.lon !== "number") return;
        let ts = null;
        if (d.timestamp && d.timestamp.toDate) {
          ts = d.timestamp.toDate();
        }
        allStays.push({
          id: doc.id,
          memberId: d.memberId || d.memberID || null,
          areaId: d.areaId || null,
          areaName: d.areaName || null,
          lat: d.lat,
          lon: d.lon,
          ts: ts
        });
      });
      addLocalLog("Naƒç√≠tan√Ωch stays: " + allStays.length);
      redrawStays();
    }, function (err) {
      console.error(err);
      setFirebaseStatus(false, "stays listener ERROR");
      addLocalLog("Firestore chyba pri naƒç√≠tan√≠ stays: " + err.message);
    });
}

// =====================================================
//  MONITORING ‚Äì ZMENA REV√çRU V SELECTE
// =====================================================
function fitToRevir(key) {
  const r = REVIROVE[key];
  if (!r || !r.coords || !r.coords.length) return;
  const latlngs = r.coords.map(c => [c[0], c[1]]);
  try {
    map.fitBounds(L.latLngBounds(latlngs).pad(0.2));
  } catch (e) {}
}

function onMonitorRevirChange(key) {
  currentMonitorKey = key || "";
  addLocalLog("Monitoring ‚Äì filter rev√≠r: " + (currentMonitorKey || "v≈°etky"));
  redrawStays();
  if (currentMonitorKey) {
    fitToRevir(currentMonitorKey);
  }
}

if (monitorRevirSelect) {
  monitorRevirSelect.addEventListener("change", function () {
    onMonitorRevirChange(this.value);
  });
}

// =====================================================
//  MONITORING ‚Äì EXPORT CSV
// =====================================================
function exportStaysCSV() {
  if (!allStays.length) {
    alert("≈Ωiadne d√°ta na export.");
    return;
  }
  const key = currentMonitorKey;
  const filtered = allStays.filter(ev => !key || ev.areaId === key);
  if (!filtered.length) {
    alert("Pre zvolen√Ω rev√≠r nie s√∫ ≈æiadne d√°ta.");
    return;
  }

  const header = "memberId;areaId;areaName;lat;lon;timestamp\n";
  const rows = filtered.map(ev => {
    const tsIso = ev.ts ? ev.ts.toISOString() : "";
    return [
      ev.memberId || "",
      ev.areaId || "",
      ev.areaName || "",
      ev.lat,
      ev.lon,
      tsIso
    ].join(";");
  });

  const csv = header + rows.join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href     = url;
  a.download = (key || "vsetky_reviry") + "_stays.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  addLocalLog("CSV export stays pre filter: " + (key || "v≈°etky"));
}

// =====================================================
//  STATICK√â VYKRESLENIE V≈†ETK√ùCH REV√çROV
// =====================================================
function drawAllReviresStatic() {
  revirLayerStatic.clearLayers();
  Object.keys(REVIROVE).forEach(key => {
    const r = REVIROVE[key];
    if (!r || !r.coords || !r.coords.length) return;
    const latlngs = r.coords.map(c => [c[0], c[1]]);
    let layer;
    if (r.type === "polygon") {
      layer = L.polygon(latlngs, {
        color: r.color || "#22c55e",
        weight: 2,
        fillColor: r.color || "#22c55e",
        fillOpacity: 0.25
      });
    } else {
      layer = L.polyline(latlngs, {
        color: r.color || "#3b82f6",
        weight: 4
      });
    }
    layer.addTo(revirLayerStatic);
    layer.bindTooltip(r.title || key, {sticky:true});

    // klik na rev√≠r ‚Äì nastav√≠ monitoring filter aj editor v√Ωber
    layer.on("click", function () {
      if (monitorRevirSelect) monitorRevirSelect.value = key;
      if (editorRevirSelect)  editorRevirSelect.value  = key;
      onMonitorRevirChange(key);
      loadEditorRevir(key);
    });
  });
}

// =====================================================
//  EDITOR REV√çROV ‚Äì PREMENN√â
// =====================================================
let editorRevirKey  = "";
let editorShape     = null;   // polygon/line layer
let editorMarkers   = [];     // editovacie body
let editorAddMode   = false;

// vymazanie editor vrstvy
function clearEditorLayer() {
  editorLayer.clearLayers();
  editorShape   = null;
  editorMarkers = [];
}

// vytvor marker pre bod
function createEditMarker(lat, lng, index) {
  const marker = L.circleMarker([lat, lng], {
    radius: 6,
    color: "#ffffff",
    weight: 2,
    fillColor: "#ff0000",
    fillOpacity: 0.9
  }).addTo(editorLayer);

  marker.bindTooltip("Bod " + index);

  marker.on("click", function () {
    removePoint(index);
  });

  editorMarkers.push(marker);
}

// refresh z REVIROVE[editorRevirKey]
function refreshEditorLayer() {
  clearEditorLayer();
  if (!editorRevirKey || !REVIROVE[editorRevirKey]) return;
  const r = REVIROVE[editorRevirKey];
  if (!r.coords || !r.coords.length) return;

  const latlngs = r.coords.map(c => [c[0], c[1]]);

  if (r.type === "polygon") {
    editorShape = L.polygon(latlngs, { color: r.color || "#22c55e", weight: 3 }).addTo(editorLayer);
  } else {
    editorShape = L.polyline(latlngs, { color: r.color || "#3b82f6", weight: 4 }).addTo(editorLayer);
  }

  for (let i = 0; i < r.coords.length; i++) {
    createEditMarker(r.coords[i][0], r.coords[i][1], i);
  }

  try {
    map.fitBounds(editorShape.getBounds(), { padding:[30,30] });
  } catch (e) {}

  updateCoordsText();
}

// naƒç√≠tanie rev√≠ru do editora
function loadEditorRevir(key) {
  editorRevirKey = key || "";
  editorAddMode  = false;
  if (!editorRevirKey) {
    clearEditorLayer();
    coordsBoxEl.value = "";
    return;
  }
  addLocalLog("Editor ‚Äì zvolen√Ω rev√≠r: " + editorRevirKey);
  refreshEditorLayer();
}

// re≈æim prid√°vania bodov
function enableAddMode() {
  if (!editorRevirKey) {
    alert("Najprv vyber rev√≠r pre edit√°ciu.");
    return;
  }
  editorAddMode = true;
  addLocalLog("Editor ‚Äì re≈æim prid√°vania bodov: ON (klikni na mapu)");
}

// klik na mapu ‚Äì pridanie bodu, len v addMode
map.on("click", function (e) {
  if (!editorAddMode || !editorRevirKey) return;
  const r = REVIROVE[editorRevirKey];
  const lat = e.latlng.lat;
  const lng = e.latlng.lng;
  r.coords.push([lat, lng]);
  addLocalLog("Editor ‚Äì pridan√Ω bod: " + lat.toFixed(6) + ", " + lng.toFixed(6));
  logToFirebase("ADD_POINT", { revir: editorRevirKey, lat, lng });
  refreshEditorLayer();
});

// odstr√°nenie konkr√©tneho bodu
function removePoint(index) {
  if (!editorRevirKey || !REVIROVE[editorRevirKey]) return;
  if (!confirm("Vymaza≈• bod #" + index + "?")) return;
  const r = REVIROVE[editorRevirKey];
  if (index < 0 || index >= r.coords.length) return;
  const removed = r.coords.splice(index, 1)[0];
  addLocalLog("Editor ‚Äì odstr√°nen√Ω bod #" + index + ": " + removed[0].toFixed(6) + ", " + removed[1].toFixed(6));
  logToFirebase("REMOVE_POINT", { revir: editorRevirKey, index, removed });
  refreshEditorLayer();
}

// zmaza≈• posledn√Ω bod
function deleteLastPoint() {
  if (!editorRevirKey || !REVIROVE[editorRevirKey]) return;
  const r = REVIROVE[editorRevirKey];
  if (!r.coords.length) return;
  const idx = r.coords.length - 1;
  removePoint(idx);
}

// reset ‚Äì vyma≈æe v≈°etky body rev√≠ru (len v pam√§ti)
function resetCurrentRevir() {
  if (!editorRevirKey || !REVIROVE[editorRevirKey]) return;
  if (!confirm("Vymaza≈• V≈†ETKY body rev√≠ru '" + editorRevirKey + "'? (len lok√°lne, neuklad√° sa nikam)")) return;
  REVIROVE[editorRevirKey].coords = [];
  addLocalLog("Editor ‚Äì reset s√∫radn√≠c rev√≠ru: " + editorRevirKey);
  logToFirebase("RESET_REVIR", { revir: editorRevirKey });
  refreshEditorLayer();
}

// export editor s√∫radn√≠c do CSV
function exportEditorCSV() {
  if (!editorRevirKey || !REVIROVE[editorRevirKey]) {
    alert("Najprv vyber rev√≠r.");
    return;
  }
  const r = REVIROVE[editorRevirKey];
  if (!r.coords.length) {
    alert("Rev√≠r nem√° ≈æiadne body.");
    return;
  }
  let csv = "lat,lng\n";
  r.coords.forEach(pt => {
    csv += pt[0] + "," + pt[1] + "\n";
  });
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href     = url;
  a.download = editorRevirKey + "_coords.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  addLocalLog("Editor ‚Äì export CSV pre rev√≠r: " + editorRevirKey);
  logToFirebase("EXPORT_CSV", { revir: editorRevirKey });
}

// update JSON text v textarea
function updateCoordsText() {
  if (!editorRevirKey || !REVIROVE[editorRevirKey]) {
    coordsBoxEl.value = "";
    return;
  }
  const r = REVIROVE[editorRevirKey];
  coordsBoxEl.value = JSON.stringify(r.coords, null, 2);
}

// =====================================================
//  FIREBASE ‚Äì ADMIN LOGS
// =====================================================
function logToFirebase(action, data) {
  if (!db) return;
  try {
    db.collection("admin_logs").add({
      action: action,
      data:   data || {},
      time:   new Date().toISOString()
    });
  } catch (e) {
    console.error("logToFirebase error", e);
  }
}

if (db) {
  db.collection("admin_logs")
    .orderBy("time", "desc")
    .limit(50)
    .onSnapshot(snap => {
      if (!adminLogBoxEl) return;
      adminLogBoxEl.innerHTML = "";
      snap.forEach(doc => {
        const d = doc.data();
        const div = document.createElement("div");
        div.className = "logEntry";
        div.innerHTML =
          "<b>" + (d.time || "") + "</b> ‚Äî " +
          "<span>" + (d.action || "") + "</span> ‚Äî " +
          JSON.stringify(d.data || {});
        adminLogBoxEl.appendChild(div);
      });
    }, err => {
      if (!adminLogBoxEl) return;
      adminLogBoxEl.textContent = "Chyba naƒç√≠tania admin_logs: " + err.message;
    });
}

// =====================================================
//  INCIDENTY ‚Äì LISTENER + DELETE + POPIS + EXPORT
// =====================================================
let allIncidents = [];

// EXPORT CSV
function exportIncidentsCSV() {
  if (!allIncidents.length) {
    alert("≈Ωiadne incidenty na export.");
    return;
  }

  const header = "memberId;type;text;lat;lon;timestamp\n";
  const rows = allIncidents.map(ev => {
    const tsIso = ev.ts ? ev.ts.toISOString() : "";
    return [
      ev.memberId || "",
      ev.type || "",
      ev.text || "",
      ev.lat,
      ev.lon,
      tsIso
    ].join(";");
  });

  const csv = header + rows.join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement("a");
  a.href     = url;
  a.download = "incidenty.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  addLocalLog("CSV export incidentov (" + allIncidents.length + ").");
}

// =====================================================
//  DELETE INCIDENT
// =====================================================
async function deleteIncident(id) {
  if (!confirm("Naozaj vymaza≈• incident?")) return;

  try {
    await db.collection("incidents").doc(id).delete();
    addLocalLog("Incident " + id + " bol vymazan√Ω.");
  } catch (err) {
    console.error(err);
    alert("Chyba pri mazan√≠ incidentu: " + err.message);
  }
}

// =====================================================
//  FIRESTORE LISTENER
// =====================================================
if (db) {
  db.collection("incidents")
    .orderBy("timestamp", "desc")
    .limit(500)
    .onSnapshot((snap) => {
      allIncidents = [];
      incidentsLayer.clearLayers();
      if (incidentsListEl) incidentsListEl.innerHTML = "";

      snap.forEach(doc => {
        const d = doc.data();
        if (!d || typeof d.lat !== "number" || typeof d.lon !== "number") return;

        let ts = d.timestamp?.toDate ? d.timestamp.toDate() : null;

        // PRIDAN√â POLIA NAVY≈†E
        const item = {
          id: doc.id,
          memberId: d.memberId || d.memberID || "NEZN√ÅMY",
          type: d.type || "Nezn√°my typ",
          text: d.text || d.description || "(bez popisu)",
          imgUrl: d.imgUrl || null,
          lat: d.lat,
          lon: d.lon,
          ts
        };

        allIncidents.push(item);

        // MARKER
        const marker = L.circleMarker([item.lat, item.lon], {
          radius: 7,
          color: "#ef4444",
          fillColor: "#ef4444",
          fillOpacity: 0.95,
          weight: 2
        }).addTo(incidentsLayer);

        const tsText = ts ? ts.toLocaleString("sk-SK") : "nezn√°my ƒças";

        // POPUP HTML ‚Äì WITH DELETE
        let popupHtml = `
          <b>üö® Incident</b><br>
          <b>ƒålen:</b> ${item.memberId}<br>
          <b>Typ:</b> ${item.type}<br>
          <b>Popis:</b><br>${item.text}<br>
          <b>ƒåas:</b> ${tsText}<br>
          <b>GPS:</b> ${item.lat.toFixed(5)}, ${item.lon.toFixed(5)}<br><br>
        `;

        if (item.imgUrl) {
          popupHtml += `<img src="${item.imgUrl}" style="width:210px; border-radius:8px; margin-bottom:10px;">`;
        }

        popupHtml += `
          <br>
          <button onclick="deleteIncident('${item.id}')"
            style="padding:8px 12px; background:#dc2626; color:white; border:none; border-radius:6px; cursor:pointer;">
            ‚ùå Vymaza≈• incident
          </button>
        `;

        marker.bindPopup(popupHtml);
        item.marker = marker;

        // ZOZNAM VƒΩAVO
        if (incidentsListEl) {
          const row = document.createElement("div");
          row.className = "logEntry";
          row.style.cursor = "pointer";
          row.style.position = "relative";

          row.innerHTML = `
            <b>üö® ${item.memberId}</b><br>
            <small>${tsText}</small><br>
            <small>${item.lat.toFixed(5)}, ${item.lon.toFixed(5)}</small><br>
            <small style="color:#66ff99;">${item.type}</small><br>
            <small style="color:#ccc;">${item.text}</small>
            <div style="position:absolute; right:10px; top:10px; cursor:pointer; font-size:20px; color:#ef4444;"
                 onclick="deleteIncident('${item.id}')">
              ‚ùå
            </div>
          `;

          row.addEventListener("click", () => {
            map.setView([item.lat, item.lon], 15);
            item.marker.openPopup();
          });

          incidentsListEl.appendChild(row);
        }
      });

      addLocalLog("Naƒç√≠tan√Ωch incidentov: " + allIncidents.length);
    }, (err) => {
      console.error("incidents listener error", err);
      if (incidentsListEl) {
        incidentsListEl.textContent = "Chyba naƒç√≠tania incidentov: " + err.message;
      }
    });
}
// =====================================================
//  TABS ‚Äì PREP√çNANIE RE≈ΩIMOV
// =====================================================
function showMonitoring() {
  monitoringControls.style.display = "block";
  editorControls.style.display     = "none";
  incidentsControls.style.display  = "none";

  tabMonitoringBtn.classList.add("active");
  tabEditorBtn.classList.remove("active");
  tabIncidentsBtn.classList.remove("active");

  setTimeout(() => map.invalidateSize(), 200);
}

function showEditor() {
  monitoringControls.style.display = "none";
  editorControls.style.display     = "block";
  incidentsControls.style.display  = "none";

  tabMonitoringBtn.classList.remove("active");
  tabEditorBtn.classList.add("active");
  tabIncidentsBtn.classList.remove("active");

  setTimeout(() => map.invalidateSize(), 200);
}

function showIncidents() {
  monitoringControls.style.display = "none";
  editorControls.style.display     = "none";
  incidentsControls.style.display  = "block";

  tabMonitoringBtn.classList.remove("active");
  tabEditorBtn.classList.remove("active");
  tabIncidentsBtn.classList.add("active");

  setTimeout(() => map.invalidateSize(), 200);
}

tabMonitoringBtn.addEventListener("click", showMonitoring);
tabEditorBtn.addEventListener("click", showEditor);
tabIncidentsBtn.addEventListener("click", showIncidents);

// =====================================================
//  INIT PO NAƒå√çTAN√ç STR√ÅNKY
// =====================================================
window.addEventListener("load", function () {
  // default: monitoring
  showMonitoring();

  // naplni≈• selecty rev√≠rmi
  Object.keys(REVIROVE).forEach(key => {
    const r = REVIROVE[key];

    if (monitorRevirSelect) {
      const o1 = document.createElement("option");
      o1.value = key;
      o1.textContent = r.title || key;
      monitorRevirSelect.appendChild(o1);
    }

    if (editorRevirSelect) {
      const o2 = document.createElement("option");
      o2.value = key;
      o2.textContent = r.title || key;
      editorRevirSelect.appendChild(o2);
    }
  });

  // vykresli≈• statick√© rev√≠ry
  drawAllReviresStatic();
});
</script>

</body>
</html>
